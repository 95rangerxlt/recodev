Regressed by bug 555120 ?

Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-05 19:23:38 PDT for push b2c600be7e90

slave: talos-mtnlion-r5-036

https://tbpl.mozilla.org/php/getParsedLog.php?id=23841469&tree=Mozilla-Inbound

{
19:25:45     INFO -  TEST-START | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js
19:25:46     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Console message: [JavaScript Error: "The character encoding of the HTML document was not declared. The document will render with garbled text in some browser configurations if the document contains characters from outside the US-ASCII range. The character encoding of the page must be declared in the document or in the transfer protocol." {file: "http://example.org/browser/browser/base/content/test/dummy_page.html" line: 0}]
19:25:46     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Console message: [JavaScript Error: "The character encoding of the HTML document was not declared. The document will render with garbled text in some browser configurations if the document contains characters from outside the US-ASCII range. The character encoding of the page must be declared in the document or in the transfer protocol." {file: "http://example.org/browser/browser/base/content/test/dummy_page.html" line: 0}]
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Initial zoom of tab 1 should be 1
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Initial zoom of tab 2 should be 1
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Initial zoom of tab 3 should be 1
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | New zoom for tab 1 should be greater than 1
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Zooming tab 1 should not affect tab 2
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Zooming tab 1 should not affect tab 3
19:25:46     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Console message: [JavaScript Error: "The character encoding of the HTML document was not declared. The document will render with garbled text in some browser configurations if the document contains characters from outside the US-ASCII range. The character encoding of the page must be declared in the document or in the transfer protocol." {file: "http://example.org/browser/browser/base/content/test/dummy_page.html" line: 0}]
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 1 should still be zoomed
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should still not be affected
19:25:46  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:25:46     INFO -  Stack trace:
19:25:46     INFO -      JS frame :: chrome://mochikit/content/browser-test.js :: test_is :: line 536
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/head.js :: zoomTest :: line 329
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js :: <TOP_LEVEL> :: line 45
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: TaskImpl_run :: line 192
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: TaskImpl :: line 163
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: Task_spawn :: line 135
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js :: thirdPageLoaded :: line 42
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 120
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: then :: line 45
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 187
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: TaskImpl_run :: line 220
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 120
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: then :: line 45
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 187
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/head.js :: <TOP_LEVEL> :: line 307
19:25:46     INFO -      native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 1 should still be zoomed
19:25:46  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
19:25:46     INFO -  Stack trace:
19:25:46     INFO -      JS frame :: chrome://mochikit/content/browser-test.js :: test_is :: line 536
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/head.js :: zoomTest :: line 329
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js :: <TOP_LEVEL> :: line 50
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: TaskImpl_run :: line 192
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 120
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: then :: line 45
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 187
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/head.js :: obs :: line 293
19:25:46     INFO -      JS frame :: chrome://browser/content/browser.js :: FullZoom__notifyOnLocationChange/< :: line 1845
19:25:46     INFO -      native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
}

Regressed by bug 555120 ?

Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-05 19:23:38 PDT for push b2c600be7e90

slave: talos-mtnlion-r5-036

https://tbpl.mozilla.org/php/getParsedLog.php?id=23841469&tree=Mozilla-Inbound

{
19:25:45     INFO -  TEST-START | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js
19:25:46     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Console message: [JavaScript Error: "The character encoding of the HTML document was not declared. The document will render with garbled text in some browser configurations if the document contains characters from outside the US-ASCII range. The character encoding of the page must be declared in the document or in the transfer protocol." {file: "http://example.org/browser/browser/base/content/test/dummy_page.html" line: 0}]
19:25:46     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Console message: [JavaScript Error: "The character encoding of the HTML document was not declared. The document will render with garbled text in some browser configurations if the document contains characters from outside the US-ASCII range. The character encoding of the page must be declared in the document or in the transfer protocol." {file: "http://example.org/browser/browser/base/content/test/dummy_page.html" line: 0}]
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Initial zoom of tab 1 should be 1
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Initial zoom of tab 2 should be 1
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Initial zoom of tab 3 should be 1
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | New zoom for tab 1 should be greater than 1
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Zooming tab 1 should not affect tab 2
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Zooming tab 1 should not affect tab 3
19:25:46     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Console message: [JavaScript Error: "The character encoding of the HTML document was not declared. The document will render with garbled text in some browser configurations if the document contains characters from outside the US-ASCII range. The character encoding of the page must be declared in the document or in the transfer protocol." {file: "http://example.org/browser/browser/base/content/test/dummy_page.html" line: 0}]
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 1 should still be zoomed
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should still not be affected
19:25:46  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:25:46     INFO -  Stack trace:
19:25:46     INFO -      JS frame :: chrome://mochikit/content/browser-test.js :: test_is :: line 536
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/head.js :: zoomTest :: line 329
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js :: <TOP_LEVEL> :: line 45
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: TaskImpl_run :: line 192
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: TaskImpl :: line 163
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: Task_spawn :: line 135
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js :: thirdPageLoaded :: line 42
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 120
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: then :: line 45
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 187
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: TaskImpl_run :: line 220
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 120
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: then :: line 45
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 187
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/head.js :: <TOP_LEVEL> :: line 307
19:25:46     INFO -      native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
19:25:46     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 1 should still be zoomed
19:25:46  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
19:25:46     INFO -  Stack trace:
19:25:46     INFO -      JS frame :: chrome://mochikit/content/browser-test.js :: test_is :: line 536
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/head.js :: zoomTest :: line 329
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js :: <TOP_LEVEL> :: line 50
19:25:46     INFO -      JS frame :: resource://gre/modules/Task.jsm :: TaskImpl_run :: line 192
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 120
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: then :: line 45
19:25:46     INFO -      JS frame :: resource://gre/modules/commonjs/sdk/core/promise.js :: resolve :: line 187
19:25:46     INFO -      JS frame :: chrome://mochitests/content/browser/browser/base/content/test/head.js :: obs :: line 293
19:25:46     INFO -      JS frame :: chrome://browser/content/browser.js :: FullZoom__notifyOnLocationChange/< :: line 1845
19:25:46     INFO -      native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
}
WinXP:
https://tbpl.mozilla.org/php/getParsedLog.php?id=23847202&tree=Mozilla-Inbound
https://tbpl.mozilla.org/php/getParsedLog.php?id=23854937&tree=Mozilla-Inbound
https://tbpl.mozilla.org/php/getParsedLog.php?id=23855058&tree=Birch
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=23860956&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-06 08:28:44
slave: talos-mtnlion-r5-083

08:31:50  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
08:31:50  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should still be zoomed - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23861244&tree=Profiling
Rev5 MacOSX Mountain Lion 10.8 profiling opt test mochitest-browser-chrome on 2013-06-06 08:37:14
slave: talos-mtnlion-r5-007

08:40:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
08:40:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
08:46:08  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
:jonco
https://tbpl.mozilla.org/php/getParsedLog.php?id=23861382&tree=Try
Rev4 MacOSX Lion 10.7 try opt test mochitest-browser-chrome on 2013-06-06 08:24:40
slave: talos-r4-lion-030

08:29:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
08:29:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23866624&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-06 10:56:16
slave: talos-mtnlion-r5-057

10:58:56  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:58:56  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23868632&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound debug test mochitest-browser-chrome on 2013-06-06 10:35:53
slave: talos-r4-lion-044

10:40:35  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:40:35  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should still be zoomed - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23872806&tree=Mozilla-Central
WINNT 6.2 mozilla-central opt test mochitest-browser-chrome on 2013-06-06 13:43:12
slave: t-w864-ix-008

13:46:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:46:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
(In reply to Ed Morley [:edmorley UTC+1] from comment #0)
> Regressed by bug 555120 ?

Almost certainly.
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23877580&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-06 15:21:51
slave: talos-mtnlion-r5-087

15:24:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:24:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
jorendorff
https://tbpl.mozilla.org/php/getParsedLog.php?id=23864857&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-06 10:08:03
slave: talos-mtnlion-r5-016

10:10:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:10:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
10:16:01  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23873572&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-06 14:02:35
slave: talos-mtnlion-r5-061

14:04:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:04:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23882890&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-06 17:44:05
slave: talos-mtnlion-r5-014

17:46:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
17:46:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23882752&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-06 17:38:02
slave: talos-mtnlion-r5-013

17:40:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
17:40:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23886143&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-06 20:54:13
slave: talos-mtnlion-r5-028

20:56:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
20:56:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Sigh.  I think this is what's happening in the failing runs:

1. The selected tab's page is P.
2. The test enlarges its zoom.
3. The test calls FullZoomHelper.load to load P in a background tab.
4. Because FullZoomHelper.load is called for a background tab, it
   skips waiting for the FullZoom notification it normally listens
   for before returning control to the caller.
5. The test continues and checks the background tab's zoom, but
   FullZoom hasn't changed it yet: "Got 1, expected > 1."

Step 4 is why the test fails, but there's another problem.  FullZoomHelper.load skips waiting for background tabs because FullZoom.onLocationChange doesn't update the zoom of background tabs -- but actually this is messed up.  It does update the zoom of background tabs, but only if their domains happen to match the domain of the selected tab.

Basically FullZoom doesn't handle background loads correctly:

(1) _isStateCurrent needs access to the same browser that was passed to _getState.  Otherwise it ends up comparing the domain of the browser whose zoom needs changing to the domain of the currently selected browser.  It should be comparing domains of the same browser, the browser whose zoom needs changing, before and after the async op.

(2) It's not right to have one global _zoomChangeToken.  If an async zoom change starts on a background tab because it loaded, but then the zoom is changed on the selected tab, the selected tab's zoom shouldn't clobber the background change if their domains are different.  You need a zoomChangeToken per domain.
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=23888889&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-06 22:42:56
slave: talos-mtnlion-r5-024

22:45:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
22:45:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=23888798&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-06 22:37:02
slave: talos-mtnlion-r5-037

22:39:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
22:39:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=23895084&tree=Mozilla-Inbound
Windows XP 32-bit mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 03:33:54
slave: t-xp32-ix-073

03:36:16  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
03:36:16  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=23893742&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 02:57:03
slave: talos-mtnlion-r5-071

02:59:00  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
02:59:00  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
03:04:14  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23907414&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 09:57:25
slave: talos-mtnlion-r5-035

10:00:12  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:00:12  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
10:06:06  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23908042&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 10:09:52
slave: talos-mtnlion-r5-025

10:12:24  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:12:24  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23909300&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 10:44:51
slave: talos-mtnlion-r5-033

10:47:36  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:47:36  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23909156&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-07 10:40:38
slave: talos-mtnlion-r5-073

10:43:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:43:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23908347&tree=Fx-Team
Rev5 MacOSX Mountain Lion 10.8 fx-team opt test mochitest-browser-chrome on 2013-06-07 10:17:17
slave: talos-mtnlion-r5-059

10:19:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:19:45  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23910853&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 11:21:16
slave: talos-mtnlion-r5-036

11:23:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:23:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23912092&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 11:50:45
slave: talos-mtnlion-r5-037

11:53:06  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:53:06  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
11:57:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_426329.js | currentEngine set
11:57:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_contextmenu.js | currentEngine set - Got Google, expected Foo
11:57:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_healthreport.js | Current engine is Foo - Got Google, expected Foo
11:57:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_private_search_perwindowpb.js | currentEngine set
11:57:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_private_search_perwindowpb.js | Found an unexpected tab at the end of test run: about:blank
11:57:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_private_search_perwindowpb.js | Found an unexpected unknown window at the end of test run
rnewman
https://tbpl.mozilla.org/php/getParsedLog.php?id=23911300&tree=Services-Central
Rev5 MacOSX Mountain Lion 10.8 services-central opt test mochitest-browser-chrome on 2013-06-07 11:29:47
slave: talos-mtnlion-r5-059

11:32:14  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:32:14  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23915445&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 13:21:17
slave: talos-mtnlion-r5-065

13:24:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:24:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
13:28:06  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_426329.js | currentEngine set
13:28:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_contextmenu.js | currentEngine set - Got Google, expected Foo
13:28:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_healthreport.js | Current engine is Foo - Got Google, expected Foo
13:28:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_private_search_perwindowpb.js | currentEngine set
13:28:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_private_search_perwindowpb.js | Found an unexpected tab at the end of test run: about:blank
13:28:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/search/test/browser_private_search_perwindowpb.js | Found an unexpected unknown window at the end of test run
(In reply to Drew Willcoxon :adw from comment #16)
> You need a zoomChangeToken per domain.

Hmm, do you mean per browser?

AIUI:
a) the token ensures that for a given browser, the latest zoom change always wins (i.e. ensures changes are processed in the order that they were requested)
b) the domain check ensures that for a given browser, the zoom change only applies if the page hasn't since been navigated away

For a), I kind of would have expected ordering could be preserved by content prefs somehow (does the storage API not allow guaranteeing the order of query results? or is caching getting in the way of that?). Assuming it can't be, a token seems like a good solution.

For b), it seems like things would be simpler (and more efficient) if we could cancel pending content prefs queries for a given browser on navigation start, or something like that. IIRC we talked about that and you said it was hard to do, though.
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23918371&tree=Mozilla-Central
Rev5 MacOSX Mountain Lion 10.8 mozilla-central opt test mochitest-browser-chrome on 2013-06-07 14:12:28
slave: talos-mtnlion-r5-079

14:14:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:14:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Gijs
https://tbpl.mozilla.org/php/getParsedLog.php?id=23918371&tree=Mozilla-Central
Rev5 MacOSX Mountain Lion 10.8 mozilla-central opt test mochitest-browser-chrome on 2013-06-07 14:12:28
slave: talos-mtnlion-r5-079

14:14:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:14:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23919852&tree=Fx-Team
Rev4 MacOSX Snow Leopard 10.6 fx-team debug test mochitest-browser-chrome on 2013-06-07 13:36:44
slave: talos-r4-snow-023

13:39:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:39:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
KWierso
https://tbpl.mozilla.org/php/getParsedLog.php?id=23921914&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 15:17:51
slave: talos-mtnlion-r5-026

15:19:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:19:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23927704&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-07 19:07:00
slave: talos-mtnlion-r5-076

19:09:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:09:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
I'm having a hard time answering because I've been thinking about this all day and now my brain is mush.

Storage does queue requests, and CPS uses Storage.  But you can't really rely on that when changing zoom because of reduce() and enlarge() because they're relative to some current zoom, not absolute zoom values.

Say you want to implement enlarge by writing the new content pref, and when the write is done, updating the visual zoom.  But what value should you write to CPS?  You can't base it on the current zoom level, because there may be many writes to CPS queued up.  The new enlarged zoom level has to be relative to all those changes.  So you have to write a value that you can't possibly know yet.

So then you think, I'll just update the visual zoom immediately and then schedule the pref write.  The immediate visual zoom changes and the CPS writes are interleaved, but that's OK because each is internally ordered, and they don't affect each other.  Except they do affect each other, because sometimes you have to read from CPS and use that value to set the visual zoom.  So you run into situations like a page loads and its pref is fetched from CPS, but before that finishes the user enlarges the zoom.  You can't ignore the enlarge since it came after the load.  If you don't ignore the fetch, then it clobbers the enlarge, and then you have to do the enlarge at some later point, like when its pref write completes, but you're updating visual zoom immediately, not when pref writes complete, remember?

So now you have to ignore the fetch.  What if it's a background tab that loads rather than the selected tab, its domain is the same as the selected tab's, and site-specific zoom is turned on?  Should the enlarge in the selected tab cause the background tab's pref fetch to be ignored too?  What if the user quickly switches to that background tab after enlarging the first one?

(In reply to :Gavin Sharp (use gavin@gavinsharp.com for email) from comment #30)
> For b), it seems like things would be simpler (and more efficient) if we
> could cancel pending content prefs queries for a given browser on navigation
> start, or something like that.

But if you navigate away and ultimately end up on a page with the same domain, and site-specific zoom is turned on, then the zoom should apply to the new page.

In general, if some async thing starts on a page with domain D and finishes on a page with domain D, then that async thing should affect the final page if site-specific zoom is turned on.  If it's turned off, then the async thing should only apply if it's the same browser.

Or maybe that's not right at all since when you switch tabs onLocationChange is called and updates the tab's zoom.
Gijs
https://tbpl.mozilla.org/php/getParsedLog.php?id=23929684&tree=UX
Rev5 MacOSX Mountain Lion 10.8 ux opt test mochitest-browser-chrome on 2013-06-07 22:00:52
slave: talos-mtnlion-r5-076

22:02:52  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
22:02:52  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Gijs
https://tbpl.mozilla.org/php/getParsedLog.php?id=23932697&tree=UX
Windows XP 32-bit ux pgo test mochitest-browser-chrome on 2013-06-08 03:26:01
slave: t-xp32-ix-008

03:28:07  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
03:28:07  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
03:28:59  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_tabopen_reflows.js | unexpected uninterruptible reflow 'tabPreviews_capture@chrome://browser/content/browser.js|tabPreviews_handleEvent/<@chrome://browser/content/browser.js|'
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23935985&tree=Mozilla-Central
Rev4 MacOSX Lion 10.7 mozilla-central opt test mochitest-browser-chrome on 2013-06-08 05:16:03
slave: talos-r4-lion-039

05:18:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:18:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=23935211&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-08 04:55:58
slave: talos-mtnlion-r5-062

04:57:51  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
04:57:51  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
05:02:59  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=23955649&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 03:44:01
slave: talos-mtnlion-r5-053

03:46:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
03:46:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23964771&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 09:30:58
slave: talos-mtnlion-r5-012

09:33:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:33:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
msucan
https://tbpl.mozilla.org/php/getParsedLog.php?id=23968631&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-10 10:50:13
slave: talos-mtnlion-r5-085

10:52:49  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:52:50  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23970421&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 11:29:53
slave: talos-mtnlion-r5-027

11:32:34  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:32:34  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23972675&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 12:26:05
slave: talos-mtnlion-r5-078

12:28:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
12:28:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
KWierso
https://tbpl.mozilla.org/php/getParsedLog.php?id=23975769&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 13:28:17
slave: talos-mtnlion-r5-070

13:30:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:30:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
KWierso
https://tbpl.mozilla.org/php/getParsedLog.php?id=23976128&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 13:35:54
slave: talos-mtnlion-r5-034

13:38:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:38:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
KWierso
https://tbpl.mozilla.org/php/getParsedLog.php?id=23978777&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 14:18:34
slave: talos-mtnlion-r5-020

14:20:57  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:20:57  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23979546&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 14:32:21
slave: talos-mtnlion-r5-003

14:34:31  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:34:31  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23983543&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 15:44:47
slave: talos-mtnlion-r5-051

15:46:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:46:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23981946&tree=Mozilla-Inbound
Windows XP 32-bit mozilla-inbound pgo test mochitest-browser-chrome on 2013-06-10 15:21:34
slave: t-xp32-ix-096

15:25:17  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:25:17  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23986960&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 16:43:09
slave: talos-r4-lion-079

16:45:56  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
16:45:56  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
bent
https://tbpl.mozilla.org/php/getParsedLog.php?id=23985958&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-10 16:32:20
slave: talos-mtnlion-r5-061

16:34:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
16:34:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23991034&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 18:24:31
slave: talos-mtnlion-r5-073

18:26:45  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
18:26:45  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=23992876&tree=Mozilla-Central
Rev4 MacOSX Lion 10.7 mozilla-central opt test mochitest-browser-chrome on 2013-06-10 18:53:45
slave: talos-r4-lion-019

18:57:24  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
18:57:24  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23993787&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 19:34:32
slave: talos-mtnlion-r5-078

19:36:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:36:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23974129&tree=UX
Rev5 MacOSX Mountain Lion 10.8 ux opt test mochitest-browser-chrome on 2013-06-10 12:53:39
slave: talos-mtnlion-r5-081

12:55:59  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
12:55:59  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23993909&tree=Mozilla-Inbound
Windows XP 32-bit mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 19:41:01
slave: t-xp32-ix-073

19:43:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:43:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23994140&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 19:37:14
slave: talos-r4-lion-034

19:41:09  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:41:09  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=23995876&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-10 20:35:27
slave: talos-r4-lion-043

20:38:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
20:38:28  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
jandem
https://tbpl.mozilla.org/php/getParsedLog.php?id=24004386&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-11 04:49:58
slave: talos-mtnlion-r5-014

04:52:42  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
04:52:42  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24009800&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-11 08:25:10
slave: talos-mtnlion-r5-028

08:28:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
08:28:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
08:33:17  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24009566&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-11 08:20:01
slave: talos-mtnlion-r5-048

08:23:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
08:23:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24013511&tree=Mozilla-Central
Rev4 MacOSX Lion 10.7 mozilla-central opt test mochitest-browser-chrome on 2013-06-11 09:32:34
slave: talos-r4-lion-064

09:35:14  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:35:14  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24013587&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-11 09:43:08
slave: talos-mtnlion-r5-003

09:45:32  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:45:32  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24022181&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-11 12:47:56
slave: talos-r4-lion-032

12:51:59  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
12:52:00  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24024557&tree=Mozilla-Central
Rev5 MacOSX Mountain Lion 10.8 mozilla-central opt test mochitest-browser-chrome on 2013-06-11 13:48:03
slave: talos-mtnlion-r5-041

13:51:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:51:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24024557&tree=Mozilla-Central
Rev5 MacOSX Mountain Lion 10.8 mozilla-central opt test mochitest-browser-chrome on 2013-06-11 13:48:03
slave: talos-mtnlion-r5-041

13:51:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:51:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24024846&tree=Mozilla-Central
Rev4 MacOSX Snow Leopard 10.6 mozilla-central opt test mochitest-browser-chrome on 2013-06-11 13:47:59
revision: 0acda90a6f6a
slave: talos-r4-snow-022

13:51:04  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:51:04  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24029699&tree=Mozilla-Central
Rev5 MacOSX Mountain Lion 10.8 mozilla-central opt test mochitest-browser-chrome on 2013-06-11 15:36:22
slave: talos-mtnlion-r5-015

15:38:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:38:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24031460&tree=Mozilla-Central
Rev5 MacOSX Mountain Lion 10.8 mozilla-central opt test mochitest-browser-chrome on 2013-06-11 16:15:29
slave: talos-mtnlion-r5-074

16:17:32  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
16:17:32  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24031174&tree=Mozilla-Inbound
Windows XP 32-bit mozilla-inbound debug test mochitest-browser-chrome on 2013-06-11 15:30:43
revision: 34d230cab71c
slave: t-xp32-ix-081

15:39:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:39:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24030420&tree=Fx-Team
Windows XP 32-bit fx-team pgo test mochitest-browser-chrome on 2013-06-11 15:55:59
slave: t-xp32-ix-008

15:58:12  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:58:12  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24045386&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-11 23:07:06
revision: 0c813a569658
slave: talos-mtnlion-r5-060

23:09:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
23:09:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24045948&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound debug test mochitest-browser-chrome on 2013-06-11 22:41:44
revision: 73b1a6ee8d12
slave: talos-mtnlion-r5-048

22:44:42  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
22:44:42  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
jonco
https://tbpl.mozilla.org/php/getParsedLog.php?id=24017555&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-11 11:05:15
revision: 5114c659929b
slave: talos-mtnlion-r5-048

11:08:05  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:08:05  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24062236&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-12 09:37:21
revision: ec850cf19e60
slave: talos-mtnlion-r5-012

09:40:04  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:40:04  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24063514&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-12 10:03:40
revision: aaea6b4c8f79
slave: talos-r4-lion-050

10:07:41  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:07:41  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24068144&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-12 11:53:41
revision: 7f3ec3f49260
slave: talos-mtnlion-r5-046

11:56:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:56:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
12:08:06  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/devtools/debugger/test/browser_dbg_step-out.js | expectUncaughtException was called but no uncaught exception was detected!
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24071590&tree=Fx-Team
Rev5 MacOSX Mountain Lion 10.8 fx-team opt test mochitest-browser-chrome on 2013-06-12 13:07:16
revision: b51316b2af6c
slave: talos-mtnlion-r5-058

13:09:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:09:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
13:21:39  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/devtools/debugger/test/browser_dbg_step-out.js | expectUncaughtException was called but no uncaught exception was detected!
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24071744&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-12 13:01:26
revision: 7f78ad0debff
slave: talos-r4-lion-032

13:04:39  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:04:39  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
13:20:56  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/devtools/debugger/test/browser_dbg_step-out.js | expectUncaughtException was called but no uncaught exception was detected!
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24072130&tree=Fx-Team
Rev4 MacOSX Snow Leopard 10.6 fx-team opt test mochitest-browser-chrome on 2013-06-12 13:12:47
revision: b51316b2af6c
slave: talos-r4-snow-057

13:15:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:15:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
13:30:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/devtools/debugger/test/browser_dbg_step-out.js | expectUncaughtException was called but no uncaught exception was detected!
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24072268&tree=Fx-Team
Rev4 MacOSX Lion 10.7 fx-team opt test mochitest-browser-chrome on 2013-06-12 13:12:54
revision: b51316b2af6c
slave: talos-r4-lion-034

13:16:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:16:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24074795&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound debug test mochitest-browser-chrome on 2013-06-12 13:02:37
revision: d724f48ff76c
slave: talos-r4-lion-010

13:06:05  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:06:05  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24076716&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-12 14:42:31
revision: b50aafc75977
slave: talos-r4-lion-016

14:46:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:46:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24078862&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound debug test mochitest-browser-chrome on 2013-06-12 14:16:07
revision: 9a8aaf2a65c6
slave: talos-r4-lion-084

14:20:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:20:20  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24081008&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-12 16:24:02
revision: 101be41e6536
slave: talos-mtnlion-r5-059

16:26:09  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
16:26:09  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
16:38:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/devtools/debugger/test/browser_dbg_step-out.js | expectUncaughtException was called but no uncaught exception was detected!
gps
https://tbpl.mozilla.org/php/getParsedLog.php?id=24082766&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-12 17:10:35
revision: 3dbc486831a4
slave: talos-r4-lion-076

17:13:49  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
17:13:49  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24089166&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-12 19:37:43
revision: e76b81594e4e
slave: talos-mtnlion-r5-083

19:39:52  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:39:52  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24097904&tree=Mozilla-Inbound
Rev4 MacOSX Snow Leopard 10.6 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-13 01:32:09
revision: 59181cb244fd
slave: talos-r4-snow-042

01:34:26  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
01:34:26  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
01:41:35  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_capabilities.js | uncaught exception - TypeError: snippets is undefined at about:home:89
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24079869&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-12 15:50:59
revision: 3b6cc7f0bafd
slave: talos-mtnlion-r5-051

15:53:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:53:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
15:59:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24083525&tree=Try
Rev4 MacOSX Lion 10.7 try opt test mochitest-browser-chrome on 2013-06-12 17:25:57
revision: 78b6497e043d
slave: talos-r4-lion-047

17:29:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
17:29:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
17:45:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/devtools/debugger/test/browser_dbg_step-out.js | expectUncaughtException was called but no uncaught exception was detected!
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24088224&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-12 19:17:05
revision: 6af47f28df47
slave: talos-mtnlion-r5-065

19:19:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:19:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Ms2ger%gmail.com
https://tbpl.mozilla.org/php/getParsedLog.php?id=24109827&tree=Try
Windows XP 32-bit try opt test mochitest-browser-chrome on 2013-06-13 09:20:23
revision: e3da18b554d6
slave: t-xp32-ix-096

09:23:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:23:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
09:27:37  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_capabilities.js | uncaught exception - TypeError: snippets is undefined at about:home:89
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24103742&tree=UX
Rev4 MacOSX Snow Leopard 10.6 ux opt test mochitest-browser-chrome on 2013-06-13 05:39:52
revision: 8dacd3c29fa1
slave: talos-r4-snow-078

05:42:15  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:42:15  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
05:49:37  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_capabilities.js | uncaught exception - TypeError: snippets is undefined at about:home:89
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24103669&tree=UX
Rev5 MacOSX Mountain Lion 10.8 ux opt test mochitest-browser-chrome on 2013-06-13 05:40:02
revision: 8dacd3c29fa1
slave: talos-mtnlion-r5-030

05:42:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:42:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
05:47:46  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_capabilities.js | uncaught exception - TypeError: snippets is undefined at about:home:89
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24117284&tree=UX
Rev5 MacOSX Mountain Lion 10.8 ux opt test mochitest-browser-chrome on 2013-06-13 12:27:11
revision: 60d15403b051
slave: talos-mtnlion-r5-022

12:29:56  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_URLBarSetURI.js | Test timed out
12:29:58  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_URLBarSetURI.js | Found a browser window after previous test timed out
12:30:08  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
12:30:08  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24121442&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-13 13:56:00
revision: 1b40028e5891
slave: talos-mtnlion-r5-026

13:58:26  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:58:26  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
harth
https://tbpl.mozilla.org/php/getParsedLog.php?id=24121528&tree=Fx-Team
Rev5 MacOSX Mountain Lion 10.8 fx-team opt test mochitest-browser-chrome on 2013-06-13 13:58:16
revision: bb4f883bfa10
slave: talos-mtnlion-r5-059

14:00:39  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:00:39  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
14:06:25  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - TypeError: snippets is undefined at about:home:89
MattN
https://tbpl.mozilla.org/php/getParsedLog.php?id=24117963&tree=UX
Rev4 MacOSX Lion 10.7 ux opt test mochitest-browser-chrome on 2013-06-13 12:35:23
revision: e8cbe272eb57
slave: talos-r4-lion-073

12:38:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
12:38:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24126056&tree=Services-Central
Rev5 MacOSX Mountain Lion 10.8 services-central opt test mochitest-browser-chrome on 2013-06-13 15:39:53
revision: bb4f883bfa10
slave: talos-mtnlion-r5-065

15:41:59  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:41:59  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
15:47:42  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - TypeError: snippets is undefined at about:home:89
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24126050&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-13 15:37:41
revision: 3d4a1926278d
slave: talos-mtnlion-r5-061

15:39:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:39:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should still be zoomed - Got 1, expected 1.100000023841858
15:40:01  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug553455.js | Should be only one notification - Got 0, expected 1
15:41:49  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug553455.js | Test timed out
15:41:52  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug553455.js | Found a tab after previous test timed out: http://example.com/browser/toolkit/mozapps/extensions/test/xpinstall/installtrigger.html?%7B%22XPI%22%3A%22unsigned.xpi%22%7D
15:41:52  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug553455.js | Found a Addons:Install after previous test timed out
15:47:20  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - TypeError: snippets is undefined at about:home:89
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24128443&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-13 16:37:27
revision: b5d440b71e59
slave: talos-mtnlion-r5-079

16:39:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
16:39:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24129256&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-13 16:54:31
revision: 7a41df37be7e
slave: talos-mtnlion-r5-046

16:56:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
16:56:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Created attachment 762453
part 1: nsIContentPrefPending

This adds an nsIContentPrefPending interface that can be used to cancel pending CPS requests, like mozIStoragePendingStatement in Storage.  The FullZoom patch I'm about to post uses it.  This is equivalent to the token approach I was using before, but now all consumers can benefit.  I guess it's slightly better than the tokens, but after implementing and using it I'm not 100% convinced it's really worth it.  So please don't feel you have to prefer this big change over the tokens just because I did all the work of implementing it.

Originally I exposed mozIStoragePendingStatement directly, but Gavin thought it was a little better to not expose that implementation detail, which I agree with, although neither of us were 100% about that either.
Created attachment 762455
part 2: FullZoom

As I mentioned nsIContentPrefPending is equivalent to the tokens, so that's not the big deal here.  The big deals are:

* associating async zoom accesses with specific browsers
* canceling async zoom accesses for a browser when its location changes and
  its zoom is updated
* onLocationChange calling _notifyOnLocationChange in all cases (it previously
  did not when getByDomainAndName finishes but the state is no longer current)
* and the change in head.js to hook into the previous point.

https://tbpl.mozilla.org/?tree=Try&rev=66fa775c7dd0
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24133394&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-13 18:45:20
revision: 99fa110edd75
slave: talos-r4-lion-085

18:47:25  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
18:47:25  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24135448&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-13 19:34:12
revision: b06b9c8b19a3
slave: talos-r4-lion-044

19:37:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:37:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
nfitzgerald%mozilla.com
https://tbpl.mozilla.org/php/getParsedLog.php?id=24135199&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-13 19:38:12
revision: dc67f2957799
slave: talos-mtnlion-r5-071

19:40:31  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:40:31  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24136791&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-13 20:20:55
revision: 1f7fdff2c4f0
slave: talos-mtnlion-r5-008

20:23:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
20:23:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
jonco
https://tbpl.mozilla.org/php/getParsedLog.php?id=24149232&tree=Try
Windows XP 32-bit try opt test mochitest-browser-chrome on 2013-06-14 05:43:03
revision: f6a9c1821690
slave: t-xp32-ix-083

05:46:08  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:46:08  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24159375&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-14 11:09:59
revision: 4ee84aacb4de
slave: talos-mtnlion-r5-077

11:12:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:12:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24162610&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-14 12:22:07
revision: 5f243d3f45be
slave: talos-mtnlion-r5-061

12:24:46  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
12:24:46  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24164645&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-14 13:12:06
revision: 219d5783b18f
slave: talos-mtnlion-r5-074

13:14:22  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:14:22  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24156863&tree=UX
Rev4 MacOSX Lion 10.7 ux opt test mochitest-browser-chrome on 2013-06-14 09:43:17
revision: cd6b6424d334
slave: talos-r4-lion-013

09:46:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:46:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Comment on attachment 762455
part 2: FullZoom

Try revealed a problem that I'm fixing.  (Cancelables can end up getting canceled more than once, which agitates mozIStoragePendingStatement.)  I'll post a new patch when try reveals no more problems.

Review on the other patch can go ahead still.
nalexander
https://tbpl.mozilla.org/php/getParsedLog.php?id=24130665&tree=Services-Central
Rev5 MacOSX Mountain Lion 10.8 services-central opt test mochitest-browser-chrome on 2013-06-13 17:36:02
revision: 1544dcd2f78a
slave: talos-mtnlion-r5-018

17:38:14  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
17:38:14  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24171115&tree=Mozilla-Central
Ubuntu VM 12.04 mozilla-central pgo test mochitest-browser-chrome on 2013-06-14 15:11:07
revision: 5ddb1bf96261
slave: tst-linux32-ec2-074

15:13:53  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:13:53  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24172445&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-14 16:05:33
revision: cbf52dea3df1
slave: talos-mtnlion-r5-086

16:07:34  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
16:07:34  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24175560&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-14 17:03:05
revision: 9e0bf0548e48
slave: talos-mtnlion-r5-065

17:05:17  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
17:05:17  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24176185&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-14 17:14:22
revision: 8bce22008b25
slave: talos-mtnlion-r5-032

17:16:41  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
17:16:42  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24180237&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-14 18:47:00
revision: a8e3d80187d1
slave: talos-r4-lion-044

18:49:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
18:49:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Created attachment 763059
part 2: FullZoom

Small change to allow pending zoom access objects to be canceled more than once.  Comment 106 applies to this too.

There are many failures on try, but none look related: https://tbpl.mozilla.org/?tree=Try&rev=3bf5c33d1a1c
Created attachment 763061
patrt 3: update private browsing test

My previous patch made this test fail.  I'm not 100% sure why -- or how it passed after the original async FullZoom bug.  I think it has to do with timings of accesses to CPS's storage, which accesses are queued up and serviced at what time.

The previous patch made it fail after it enlarges a tab, switches away, and then switches back.  When the test then checked the zoom, it was still 1 when it should have been > 1.  This patch makes it carefully wait whenever it selects and loads tabs, like all the other tests I updated in the original async FullZoom bug.
msucan
https://tbpl.mozilla.org/php/getParsedLog.php?id=24165139&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-14 13:25:01
revision: a1f52bbe9a43
slave: talos-mtnlion-r5-061

13:27:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
13:27:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24192157&tree=Mozilla-Central
Rev4 MacOSX Lion 10.7 mozilla-central opt test mochitest-browser-chrome on 2013-06-15 05:26:13
revision: 7f8de495bf6d
slave: talos-r4-lion-036

05:29:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:29:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24203949&tree=Fx-Team
Windows XP 32-bit fx-team opt test mochitest-browser-chrome on 2013-06-15 20:07:02
revision: 88cd07a112ae
slave: t-xp32-ix-091

20:09:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
20:09:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24204488&tree=Mozilla-Central
Rev4 MacOSX Lion 10.7 mozilla-central opt test mochitest-browser-chrome on 2013-06-15 20:20:40
revision: 36da3cb92193
slave: talos-r4-lion-054

20:24:31  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
20:24:31  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24210774&tree=Fx-Team
Windows 7 32-bit fx-team pgo test mochitest-browser-chrome on 2013-06-16 08:44:47
revision: 19b3d7dc3d7c
slave: t-w732-ix-127

08:50:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
08:50:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24174780&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-14 16:48:46
revision: 85804cbf8361
slave: talos-mtnlion-r5-057

16:50:50  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
16:50:50  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24227336&tree=Mozilla-Central
Rev4 MacOSX Snow Leopard 10.6 mozilla-central debug test mochitest-browser-chrome on 2013-06-17 02:05:02
revision: cfb4d238a7fc
slave: talos-r4-snow-008

02:08:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
02:08:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
gfritzsche
https://tbpl.mozilla.org/php/getParsedLog.php?id=24230840&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-17 05:22:58
revision: 5bcb42488dd9
slave: talos-mtnlion-r5-018

05:25:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:25:44  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24229249&tree=Try
Rev4 MacOSX Snow Leopard 10.6 try opt test mochitest-browser-chrome on 2013-06-17 04:19:09
revision: 996781cb1604
slave: talos-r4-snow-051

04:21:36  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
04:21:36  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24223297&tree=Try
Rev4 MacOSX Snow Leopard 10.6 try debug test mochitest-browser-chrome on 2013-06-16 22:42:08
revision: 9d3818f3c3d1
slave: talos-r4-snow-082

22:45:00  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
22:45:01  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24232133&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 06:27:03
revision: 9c39cd5ddbc5
slave: talos-mtnlion-r5-013

06:30:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
06:30:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24237424&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound debug test mochitest-browser-chrome on 2013-06-17 08:33:31
revision: 95d757b44adc
slave: talos-r4-lion-043

08:37:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
08:37:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24238255&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 10:08:55
revision: 07708c9fc5ef
slave: talos-mtnlion-r5-056

10:11:25  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:11:25  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
jhammel
https://tbpl.mozilla.org/php/getParsedLog.php?id=24239723&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-17 10:45:12
revision: 87e714859513
slave: talos-mtnlion-r5-052

10:47:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:47:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
10:53:24  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24242236&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 11:35:46
revision: f0db2c84b4d1
slave: talos-mtnlion-r5-058

11:38:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:38:13  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24242424&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 11:33:43
revision: 8b4b7306f981
slave: talos-r4-lion-085

11:35:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:35:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24242810&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 11:45:17
revision: f0db2c84b4d1
slave: talos-r4-lion-026

11:48:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
11:48:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
gavin
https://tbpl.mozilla.org/php/getParsedLog.php?id=24247483&tree=Mozilla-Inbound
Windows XP 32-bit mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 14:03:11
revision: 99761867d59c
slave: t-xp32-ix-014

14:05:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:05:30  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
14:06:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js | Exception thrown at chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js:32 - TypeError: SocialService.getOriginActivationType is not a function
14:06:57  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_activation.js | sub-test testActivationBuiltin failed: TypeError: SocialService.getOriginActivationType is not a function
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24249655&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 14:41:49
revision: 7df3c21c72e9
slave: talos-mtnlion-r5-026

14:44:18  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:44:18  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
14:46:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js | Exception thrown at chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js:32 - TypeError: SocialService.getOriginActivationType is not a function
14:46:58  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_activation.js | sub-test testActivationBuiltin failed: TypeError: SocialService.getOriginActivationType is not a function
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24251363&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 15:14:03
revision: ec253175bb51
slave: talos-mtnlion-r5-019

15:16:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:16:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
15:19:34  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js | Exception thrown at chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js:32 - TypeError: SocialService.getOriginActivationType is not a function
15:19:41  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_activation.js | sub-test testActivationBuiltin failed: TypeError: SocialService.getOriginActivationType is not a function
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24252177&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 15:29:14
revision: f4f6c5f89800
slave: talos-mtnlion-r5-078

15:31:16  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:31:16  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
15:33:53  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js | Exception thrown at chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js:32 - TypeError: SocialService.getOriginActivationType is not a function
15:33:56  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_activation.js | sub-test testActivationBuiltin failed: TypeError: SocialService.getOriginActivationType is not a function
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24253045&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 15:44:21
revision: 65cd5eac8b2e
slave: talos-mtnlion-r5-082

15:46:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:46:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
15:49:26  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js | Exception thrown at chrome://mochitests/content/browser/browser/base/content/test/social/browser_addons.js:32 - TypeError: SocialService.getOriginActivationType is not a function
15:49:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_activation.js | sub-test testActivationBuiltin failed: TypeError: SocialService.getOriginActivationType is not a function
15:52:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24263269&tree=Mozilla-Inbound
Rev4 MacOSX Snow Leopard 10.6 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 19:17:36
revision: 090ebbb90a7f
slave: talos-r4-snow-038

19:19:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:19:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24259687&tree=Services-Central
Rev5 MacOSX Mountain Lion 10.8 services-central opt test mochitest-browser-chrome on 2013-06-17 18:15:09
revision: 31f1458c6a0b
slave: talos-mtnlion-r5-073

18:17:22  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
18:17:22  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24264843&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-17 19:57:21
revision: ebc9b2b98ad7
slave: talos-mtnlion-r5-041

19:59:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:59:40  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24273401&tree=Mozilla-Inbound
Windows XP 32-bit mozilla-inbound pgo test mochitest-browser-chrome on 2013-06-18 00:12:07
revision: 5e674c399e3e
slave: t-xp32-ix-017

00:14:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
00:14:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
:jonco
https://tbpl.mozilla.org/php/getParsedLog.php?id=24238896&tree=Try
Rev4 MacOSX Lion 10.7 try debug test mochitest-browser-chrome on 2013-06-17 09:11:45
revision: 997b2381ddef
slave: talos-r4-lion-079

09:17:15  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:17:15  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
:jonco
https://tbpl.mozilla.org/php/getParsedLog.php?id=24238412&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try opt test mochitest-browser-chrome on 2013-06-17 10:12:19
revision: 997b2381ddef
slave: talos-mtnlion-r5-081

10:15:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:15:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24276135&tree=Mozilla-Inbound
Rev4 MacOSX Snow Leopard 10.6 mozilla-inbound debug test mochitest-browser-chrome on 2013-06-18 01:09:58
revision: a0f434c4d17c
slave: talos-r4-snow-025

01:13:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
01:13:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24279076&tree=Mozilla-Inbound
Rev4 MacOSX Snow Leopard 10.6 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-18 03:14:47
revision: 6adf3351d77d
slave: talos-r4-snow-038

03:17:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
03:17:38  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24283920&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-18 05:39:20
revision: 24308e64b91c
slave: talos-mtnlion-r5-059

05:41:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:41:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24283920&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-18 05:39:20
revision: 24308e64b91c
slave: talos-mtnlion-r5-059

05:41:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:41:54  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24284423&tree=Mozilla-Central
Rev5 MacOSX Mountain Lion 10.8 mozilla-central opt test mochitest-browser-chrome on 2013-06-18 05:50:03
revision: 58b1f6b4b570
slave: talos-mtnlion-r5-086

05:52:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
05:52:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24289473&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-18 08:01:48
revision: 045aa030111e
slave: talos-mtnlion-r5-058

08:04:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
08:04:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
dkeeler
https://tbpl.mozilla.org/php/getParsedLog.php?id=24265454&tree=Try
Rev5 MacOSX Mountain Lion 10.8 try debug test mochitest-browser-chrome on 2013-06-17 19:24:15
revision: cbc8a743d45e
slave: talos-mtnlion-r5-087

19:27:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
19:27:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should still be zoomed - Got 1, expected 1.100000023841858
ttaubert
https://tbpl.mozilla.org/php/getParsedLog.php?id=24292444&tree=Fx-Team
Rev5 MacOSX Mountain Lion 10.8 fx-team opt test mochitest-browser-chrome on 2013-06-18 09:19:00
revision: 24e725b72a0d
slave: talos-mtnlion-r5-034

09:21:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:21:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24293452&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-18 09:39:09
revision: 175f9d9b9918
slave: talos-mtnlion-r5-058

09:41:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:41:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24293209&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-18 09:32:57
revision: c506a6940d07
slave: talos-mtnlion-r5-072

09:36:00  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:36:00  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24293209&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-18 09:32:57
revision: c506a6940d07
slave: talos-mtnlion-r5-072

09:36:00  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:36:00  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
KWierso
https://tbpl.mozilla.org/php/getParsedLog.php?id=24303392&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-18 14:06:00
revision: 3e48ae462b0d
slave: talos-mtnlion-r5-036

14:08:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
14:08:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24305726&tree=Mozilla-Inbound
Windows XP 32-bit mozilla-inbound opt test mochitest-browser-chrome on 2013-06-18 14:57:02
revision: 38f0844975f2
slave: t-xp32-ix-091

15:01:48  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:01:49  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=24306764&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-18 15:17:34
revision: 2e810d6c8779
slave: talos-mtnlion-r5-059

15:19:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:19:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Tomcat
https://tbpl.mozilla.org/php/getParsedLog.php?id=24325299&tree=Mozilla-Inbound
Rev5 MacOSX Mountain Lion 10.8 mozilla-inbound debug test mochitest-browser-chrome on 2013-06-19 00:11:24
revision: 7c148efceaf9
slave: talos-mtnlion-r5-021

00:14:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
00:14:47  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=24326298&tree=Mozilla-Inbound
Rev4 MacOSX Snow Leopard 10.6 mozilla-inbound opt test mochitest-browser-chrome on 2013-06-19 01:56:08
revision: 734147446def
slave: talos-r4-snow-051

01:58:37  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
01:58:37  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Disabled temporarily whilst waiting for review to reduce the noise, since my spidey sense says it may be a while... ;-)
https://hg.mozilla.org/integration/mozilla-inbound/rev/84e4bef463e5
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24342677&tree=UX
Rev5 MacOSX Mountain Lion 10.8 ux opt test mochitest-browser-chrome on 2013-06-19 10:29:32
revision: 408f7960fc2b
slave: talos-mtnlion-r5-058

10:32:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
10:32:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
10:38:22  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_707862.js | uncaught exception - [object XrayWrapper [object Event]] at undefined:undefined
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24348212&tree=Birch
Rev5 MacOSX Mountain Lion 10.8 birch opt test mochitest-browser-chrome on 2013-06-19 12:40:24
revision: 2f49ab9a4da4
slave: talos-mtnlion-r5-050

12:43:04  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
12:43:04  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
https://hg.mozilla.org/mozilla-central/rev/84e4bef463e5
Are you sure we can rely on pendingStatement cancelation? As far as I know it's really not something I'd rely on, cause it may happen at any time, the statement may have already selected and returned all of the results, maybe even completed, when you cancel it. It's hard to rely on something that depends on a thread scheduler. iirc the idea behind Cancel() was originally implemented to allow to stop fetching results while fetching many results, most for performance reasons that for other, indeed after you invoke it, you may even still get some results.

Now, the issues is quite complicated and I'm pretty sure you have a much deeper knowledge of the issue than me, I could barely follow all of the description above.
I was wondering if we couldn't use a queue of changes here, where before returning from any operation we walk up the queue and see if next requests may clobber, if so enqueue the callback, there may be a queue for each domain and you could clean it up with a reasonable count limit.

Though, if you think your implementation does not rely on specific schedule of Cancel() calls it may be fine to proceed with it.
or well, once an operation completes is may remove everything in queue before itself, a monotonic token to identify the operation could help.
(In reply to Marco Bonardo [:mak] from comment #173)
> Are you sure we can rely on pendingStatement cancelation? As far as I know
> it's really not something I'd rely on, cause it may happen at any time, the
> statement may have already selected and returned all of the results, maybe
> even completed, when you cancel it.

That's true.  My FullZoom patch only cancels getters, though, and it doesn't care if any results were actually gotten.  It uses cancel() only as a way to mark getter requests so that it can ignore them when they finish.

This is a good point you make.  We should probably forget this cancelable patch.  The CPS API shouldn't lead consumers to believe that requests can actually be canceled before they affect the database.

> I was wondering if we couldn't use a queue of changes here, where before
> returning from any operation we walk up the queue and see if next requests
> may clobber, if so enqueue the callback, there may be a queue for each
> domain and you could clean it up with a reasonable count limit.

Hmm, I'll have to think about that.  My initial impression is that queues sound unnecessary when you could simply keep a monotonic token per domain.  Right?  Simply store the current maximum token in a queue (i.e., the token of the operation at the end of the queue) and then you don't actually need the queue at all.

Thanks for helping me with this!
Comment on attachment 762453
part 1: nsIContentPrefPending

>diff --git a/content/html/content/src/HTMLInputElement.cpp b/content/html/content/src/HTMLInputElement.cpp
>--- a/content/html/content/src/HTMLInputElement.cpp
>+++ b/content/html/content/src/HTMLInputElement.cpp
>@@ -540,17 +540,18 @@ UploadLastDir::FetchDirectoryAndDisplayP
>     prefCallback->HandleCompletion(nsIContentPrefCallback2::COMPLETE_ERROR);
>     return NS_OK;
>   }
> 
>   nsAutoCString cstrSpec;
>   docURI->GetSpec(cstrSpec);
>   NS_ConvertUTF8toUTF16 spec(cstrSpec);
> 
>-  contentPrefService->GetByDomainAndName(spec, CPS_PREF_NAME, loadContext, prefCallback);
>+  nsCOMPtr<nsIContentPrefPending> pending;
>+  contentPrefService->GetByDomainAndName(spec, CPS_PREF_NAME, loadContext, prefCallback, getter_AddRefs(pending));
>   return NS_OK;
> }
> 
> nsresult
> UploadLastDir::StoreLastUsedDirectory(nsIDocument* aDoc, nsIDOMFile* aDomFile)
> {
>   NS_PRECONDITION(aDoc, "aDoc is null");
>   NS_PRECONDITION(aDomFile, "aDomFile is null");
>@@ -592,27 +593,31 @@ UploadLastDir::StoreLastUsedDirectory(ns
>     return NS_OK;
>   nsCOMPtr<nsIWritableVariant> prefValue = do_CreateInstance(NS_VARIANT_CONTRACTID);
>   if (!prefValue)
>     return NS_ERROR_OUT_OF_MEMORY;
>   prefValue->SetAsAString(unicodePath);
> 
>   nsCOMPtr<nsISupports> container = aDoc->GetContainer();
>   nsCOMPtr<nsILoadContext> loadContext = do_QueryInterface(container);
>-  return contentPrefService->Set(spec, CPS_PREF_NAME, prefValue, loadContext, nullptr);
>+  nsCOMPtr<nsIContentPrefPending> pending;
>+  return contentPrefService->Set(spec, CPS_PREF_NAME, prefValue, loadContext, nullptr, getter_AddRefs(pending));
> }
> 
> NS_IMETHODIMP
> UploadLastDir::Observe(nsISupports* aSubject, char const* aTopic, PRUnichar const* aData)
> {
>   if (strcmp(aTopic, "browser:purge-session-history") == 0) {
>     nsCOMPtr<nsIContentPrefService2> contentPrefService =
>       do_GetService(NS_CONTENT_PREF_SERVICE_CONTRACTID);
>-    if (contentPrefService)
>-      contentPrefService->RemoveByName(CPS_PREF_NAME, nullptr, nullptr);
>+    if (contentPrefService) {
>+      nsCOMPtr<nsIContentPrefPending> pending;
>+      contentPrefService->RemoveByName(CPS_PREF_NAME, nullptr, nullptr,
>+                                       getter_AddRefs(pending));
>+    }
>   }
>   return NS_OK;
> }
> 
> #ifdef ACCESSIBILITY
> //Helper method
> static nsresult FireEventForAccessibility(nsIDOMHTMLInputElement* aTarget,
>                                           nsPresContext* aPresContext,
>diff --git a/dom/interfaces/base/nsIContentPrefService2.idl b/dom/interfaces/base/nsIContentPrefService2.idl
>--- a/dom/interfaces/base/nsIContentPrefService2.idl
>+++ b/dom/interfaces/base/nsIContentPrefService2.idl
>@@ -4,16 +4,17 @@
> 
> #include "nsISupports.idl"
> 
> interface nsIVariant;
> interface nsIContentPrefObserver;
> interface nsIContentPrefCallback2;
> interface nsILoadContext;
> interface nsIContentPref;
>+interface nsIContentPrefPending;
> 
> /**
>  * Content Preferences
>  *
>  * Content preferences allow the application to associate arbitrary data, or
>  * "preferences", with specific domains, or web "content".  Specifically, a
>  * content preference is a structure with three values: a domain with which the
>  * preference is associated, a name that identifies the preference within its
>@@ -62,59 +63,62 @@ interface nsIContentPref;
>  * The methods of callback objects are always called asynchronously.
>  *
>  * Observers are called after callbacks are called, but they are called in the
>  * same turn of the event loop as callbacks.
>  *
>  * See nsIContentPrefCallback2 below for more information about callbacks.
>  */
> 
>-[scriptable, uuid(133608c7-f812-41ca-bc1c-62a4eb95e52a)]
>+[scriptable, uuid(13de9efd-5ef0-4412-a4b5-66e3940c6f5b)]
> interface nsIContentPrefService2 : nsISupports
> {
>   /**
>    * Gets the preference with the given domain and name.
>    *
>    * @param domain    The preference's domain.
>    * @param name      The preference's name.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleResult is called once unless no such preference
>    *                  exists, in which case handleResult is not called at all.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void getByDomainAndName(in AString domain,
>-                          in AString name,
>-                          in nsILoadContext context,
>-                          in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending getByDomainAndName(in AString domain,
>+                                           in AString name,
>+                                           in nsILoadContext context,
>+                                           in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Gets all preferences with the given name whose domains are either the same
>    * as or subdomains of the given domain.
>    *
>    * @param domain    The preferences' domain.
>    * @param name      The preferences' name.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleResult is called once for each preference.  If no
>    *                  such preferences exist, handleResult is not called at all.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void getBySubdomainAndName(in AString domain,
>-                             in AString name,
>-                             in nsILoadContext context,
>-                             in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending getBySubdomainAndName(in AString domain,
>+                                              in AString name,
>+                                              in nsILoadContext context,
>+                                              in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Gets the preference with no domain and the given name.
>    *
>    * @param name      The preference's name.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleResult is called once unless no such preference
>    *                  exists, in which case handleResult is not called at all.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void getGlobal(in AString name,
>-                 in nsILoadContext context,
>-                 in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending getGlobal(in AString name,
>+                                  in nsILoadContext context,
>+                                  in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Synchronously retrieves from the in-memory cache the preference with the
>    * given domain and name.
>    *
>    * In addition to caching preference values, the cache also keeps track of
>    * preferences that are known not to exist.  If the preference is known not to
>    * exist, the value attribute of the returned object will be undefined
>@@ -177,129 +181,139 @@ interface nsIContentPrefService2 : nsISu
>    * Sets a preference.
>    *
>    * @param domain    The preference's domain.
>    * @param name      The preference's name.
>    * @param value     The preference's value.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the preference has been
>    *                  stored.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void set(in AString domain,
>-           in AString name,
>-           in nsIVariant value,
>-           in nsILoadContext context,
>-           [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending set(in AString domain,
>+                            in AString name,
>+                            in nsIVariant value,
>+                            in nsILoadContext context,
>+                            [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Sets a preference with no domain.
>    *
>    * @param name      The preference's name.
>    * @param value     The preference's value.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the preference has been
>    *                  stored.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void setGlobal(in AString name,
>-                 in nsIVariant value,
>-                 in nsILoadContext context,
>-                 [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending setGlobal(in AString name,
>+                                  in nsIVariant value,
>+                                  in nsILoadContext context,
>+                                  [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Removes the preference with the given domain and name.
>    *
>    * @param domain    The preference's domain.
>    * @param name      The preference's name.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the operation completes.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void removeByDomainAndName(in AString domain,
>-                             in AString name,
>-                             in nsILoadContext context,
>-                             [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending removeByDomainAndName(in AString domain,
>+                                              in AString name,
>+                                              in nsILoadContext context,
>+                                              [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Removes all the preferences with the given name whose domains are either
>    * the same as or subdomains of the given domain.
>    *
>    * @param domain    The preferences' domain.
>    * @param name      The preferences' name.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the operation completes.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void removeBySubdomainAndName(in AString domain,
>-                                in AString name,
>-                                in nsILoadContext context,
>-                                [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending removeBySubdomainAndName(in AString domain,
>+                                                 in AString name,
>+                                                 in nsILoadContext context,
>+                                                 [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Removes the preference with no domain and the given name.
>    *
>    * @param name      The preference's name.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the operation completes.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void removeGlobal(in AString name,
>-                    in nsILoadContext context,
>-                    [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending removeGlobal(in AString name,
>+                                     in nsILoadContext context,
>+                                     [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Removes all preferences with the given domain.
>    *
>    * @param domain    The preferences' domain.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the operation completes.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void removeByDomain(in AString domain,
>-                      in nsILoadContext context,
>-                      [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending removeByDomain(in AString domain,
>+                                       in nsILoadContext context,
>+                                       [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Removes all preferences whose domains are either the same as or subdomains
>    * of the given domain.
>    *
>    * @param domain    The preferences' domain.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the operation completes.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void removeBySubdomain(in AString domain,
>-                         in nsILoadContext context,
>-                         [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending removeBySubdomain(in AString domain,
>+                                          in nsILoadContext context,
>+                                          [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Removes all preferences with the given name regardless of domain, including
>    * global preferences with the given name.
>    *
>    * @param name      The preferences' name.
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the operation completes.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void removeByName(in AString name,
>-                    in nsILoadContext context,
>-                    [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending removeByName(in AString name,
>+                                     in nsILoadContext context,
>+                                     [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Removes all non-global preferences -- in other words, all preferences that
>    * have a domain.
>    *
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the operation completes.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void removeAllDomains(in nsILoadContext context,
>-                        [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending removeAllDomains(in nsILoadContext context,
>+                                         [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Removes all global preferences -- in other words, all preferences that have
>    * no domain.
>    *
>    * @param context   The private-browsing context, if any.
>    * @param callback  handleCompletion is called when the operation completes.
>+   * @return  A pending object that can be used to cancel the request.
>    */
>-  void removeAllGlobals(in nsILoadContext context,
>-                        [optional] in nsIContentPrefCallback2 callback);
>+  nsIContentPrefPending removeAllGlobals(in nsILoadContext context,
>+                                         [optional] in nsIContentPrefCallback2 callback);
> 
>   /**
>    * Registers an observer that will be notified whenever a preference with the
>    * given name is set or removed.
>    *
>    * When a set or remove method is called, observers are called after the set
>    * or removal completes and after the method's callback is called, and they
>    * are called in the same turn of the event loop as the callback.
>@@ -334,17 +348,17 @@ interface nsIContentPrefService2 : nsISu
>    *             returned.  Otherwise, the string itself is returned.
>    */
>   AString extractDomain(in AString str);
> };
> 
> /**
>  * The callback used by the above methods.
>  */
>-[scriptable, uuid(1a12cf41-79e8-4d0f-9899-2f7b27c5d9a1)]
>+[scriptable, uuid(a72cee89-9546-438e-9e75-513bc46485d8)]
> interface nsIContentPrefCallback2 : nsISupports
> {
>   /**
>    * For the retrieval methods, this is called once for each retrieved
>    * preference.  It is not called for other methods.
>    *
>    * @param pref  The retrieved preference.
>    */
>@@ -365,16 +379,28 @@ interface nsIContentPrefCallback2 : nsIS
>    *
>    * @param reason  One of the COMPLETE_* values indicating the manner in which
>    *                the method completed.
>    */
>   void handleCompletion(in unsigned short reason);
> 
>   const unsigned short COMPLETE_OK = 0;
>   const unsigned short COMPLETE_ERROR = 1;
>+  const unsigned short COMPLETE_CANCELED = 2;
>+};
>+
>+[scriptable, uuid(1df07db6-5bed-467b-a08b-3a0f13e03f36)]
>+interface nsIContentPrefPending : nsISupports
>+{
>+  /**
>+   * Cancels this object's associated request.  If a callback was passed to the
>+   * request, then the callback's handleCompletion method will be called with
>+   * reason COMPLETE_CANCELED.
>+   */
>+  void cancel();
> };
> 
> [scriptable, function, uuid(9f24948d-24b5-4b1b-b554-7dbd58c1d792)]
> interface nsIContentPref : nsISupports
> {
>   readonly attribute AString domain;
>   readonly attribute AString name;
>   readonly attribute nsIVariant value;
>diff --git a/editor/composer/src/nsEditorSpellCheck.cpp b/editor/composer/src/nsEditorSpellCheck.cpp
>--- a/editor/composer/src/nsEditorSpellCheck.cpp
>+++ b/editor/composer/src/nsEditorSpellCheck.cpp
>@@ -164,19 +164,20 @@ DictionaryFetcher::Fetch(nsIEditor* aEdi
>   rv = docUri->GetSpec(docUriSpec);
>   NS_ENSURE_SUCCESS(rv, rv);
> 
>   nsCOMPtr<nsIContentPrefService2> contentPrefService =
>     do_GetService(NS_CONTENT_PREF_SERVICE_CONTRACTID);
>   NS_ENSURE_TRUE(contentPrefService, NS_ERROR_NOT_AVAILABLE);
> 
>   nsCOMPtr<nsILoadContext> loadContext = GetLoadContext(aEditor);
>+  nsCOMPtr<nsIContentPrefPending> pending;
>   rv = contentPrefService->GetByDomainAndName(NS_ConvertUTF8toUTF16(docUriSpec),
>                                               CPS_PREF_NAME, loadContext,
>-                                              this);
>+                                              this, getter_AddRefs(pending));
>   NS_ENSURE_SUCCESS(rv, rv);
> 
>   return NS_OK;
> }
> 
> /**
>  * Stores the current dictionary for aEditor's document URL.
>  */
>@@ -199,19 +200,20 @@ StoreCurrentDictionary(nsIEditor* aEdito
>   NS_ENSURE_TRUE(prefValue, NS_ERROR_OUT_OF_MEMORY);
>   prefValue->SetAsAString(aDictionary);
> 
>   nsCOMPtr<nsIContentPrefService2> contentPrefService =
>     do_GetService(NS_CONTENT_PREF_SERVICE_CONTRACTID);
>   NS_ENSURE_TRUE(contentPrefService, NS_ERROR_NOT_INITIALIZED);
> 
>   nsCOMPtr<nsILoadContext> loadContext = GetLoadContext(aEditor);
>+  nsCOMPtr<nsIContentPrefPending> pending;
>   return contentPrefService->Set(NS_ConvertUTF8toUTF16(docUriSpec),
>                                  CPS_PREF_NAME, prefValue, loadContext,
>-                                 nullptr);
>+                                 nullptr, getter_AddRefs(pending));
> }
> 
> /**
>  * Forgets the current dictionary stored for aEditor's document URL.
>  */
> static nsresult
> ClearCurrentDictionary(nsIEditor* aEditor)
> {
>@@ -227,18 +229,20 @@ ClearCurrentDictionary(nsIEditor* aEdito
>   rv = docUri->GetSpec(docUriSpec);
>   NS_ENSURE_SUCCESS(rv, rv);
> 
>   nsCOMPtr<nsIContentPrefService2> contentPrefService =
>     do_GetService(NS_CONTENT_PREF_SERVICE_CONTRACTID);
>   NS_ENSURE_TRUE(contentPrefService, NS_ERROR_NOT_INITIALIZED);
> 
>   nsCOMPtr<nsILoadContext> loadContext = GetLoadContext(aEditor);
>+  nsCOMPtr<nsIContentPrefPending> pending;
>   return contentPrefService->RemoveByDomainAndName(
>-    NS_ConvertUTF8toUTF16(docUriSpec), CPS_PREF_NAME, loadContext, nullptr);
>+    NS_ConvertUTF8toUTF16(docUriSpec), CPS_PREF_NAME, loadContext, nullptr,
>+    getter_AddRefs(pending));
> }
> 
> NS_IMPL_CYCLE_COLLECTING_ADDREF(nsEditorSpellCheck)
> NS_IMPL_CYCLE_COLLECTING_RELEASE(nsEditorSpellCheck)
> 
> NS_INTERFACE_MAP_BEGIN(nsEditorSpellCheck)
>   NS_INTERFACE_MAP_ENTRY(nsIEditorSpellCheck)
>   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIEditorSpellCheck)
>diff --git a/toolkit/components/contentprefs/ContentPrefService2.jsm b/toolkit/components/contentprefs/ContentPrefService2.jsm
>--- a/toolkit/components/contentprefs/ContentPrefService2.jsm
>+++ b/toolkit/components/contentprefs/ContentPrefService2.jsm
>@@ -38,28 +38,28 @@ function ContentPrefService2(cps) {
>   this._pbStore = cps._privModeStorage;
> }
> 
> ContentPrefService2.prototype = {
> 
>   getByDomainAndName: function CPS2_getByDomainAndName(group, name, context,
>                                                        callback) {
>     checkGroupArg(group);
>-    this._get(group, name, false, context, callback);
>+    return this._get(group, name, false, context, callback);
>   },
> 
>   getBySubdomainAndName: function CPS2_getBySubdomainAndName(group, name,
>                                                              context,
>                                                              callback) {
>     checkGroupArg(group);
>-    this._get(group, name, true, context, callback);
>+    return this._get(group, name, true, context, callback);
>   },
> 
>   getGlobal: function CPS2_getGlobal(name, context, callback) {
>-    this._get(null, name, false, context, callback);
>+    return this._get(null, name, false, context, callback);
>   },
> 
>   _get: function CPS2__get(group, name, includeSubdomains, context, callback) {
>     group = this._parseGroup(group);
>     checkNameArg(name);
>     checkCallbackArg(callback, true);
> 
>     // Some prefs may be in both the database and the private browsing store.
>@@ -68,17 +68,18 @@ ContentPrefService2.prototype = {
>     let pbPrefs = new ContentPrefStore();
>     if (context && context.usePrivateBrowsing) {
>       for (let [sgroup, val] in
>              this._pbStore.match(group, name, includeSubdomains)) {
>         pbPrefs.set(sgroup, name, val);
>       }
>     }
> 
>-    this._execStmts([this._commonGetStmt(group, name, includeSubdomains)], {
>+    let stmts = [this._commonGetStmt(group, name, includeSubdomains)];
>+    return this._execStmts(stmts, {
>       onRow: function onRow(row) {
>         let grp = row.getResultByName("grp");
>         let val = row.getResultByName("value");
>         this._cache.set(grp, name, val);
>         if (!pbPrefs.has(group, name))
>           cbHandleResult(callback, new ContentPref(grp, name, val));
>       },
>       onDone: function onDone(reason, ok, gotRow) {
>@@ -174,36 +175,42 @@ ContentPrefService2.prototype = {
>     for (let [sgroup, sname, val] in outStore) {
>       prefs.push(new ContentPref(sgroup, sname, val));
>     }
>     return prefs;
>   },
> 
>   set: function CPS2_set(group, name, value, context, callback) {
>     checkGroupArg(group);
>-    this._set(group, name, value, context, callback);
>+    return this._set(group, name, value, context, callback);
>   },
> 
>   setGlobal: function CPS2_setGlobal(name, value, context, callback) {
>-    this._set(null, name, value, context, callback);
>+    return this._set(null, name, value, context, callback);
>   },
> 
>   _set: function CPS2__set(group, name, value, context, callback) {
>     group = this._parseGroup(group);
>     checkNameArg(name);
>     checkValueArg(value);
>     checkCallbackArg(callback, false);
> 
>     if (context && context.usePrivateBrowsing) {
>-      this._pbStore.set(group, name, value);
>+      let pseudoPending = new PseudoPending();
>       this._schedule(function () {
>+        if (pseudoPending.canceled) {
>+          cbHandleCompletion(callback,
>+                             Ci.nsIContentPrefCallback2.COMPLETE_CANCELED);
>+          return;
>+        }
>+        this._pbStore.set(group, name, value);
>         cbHandleCompletion(callback, Ci.nsIContentPrefCallback2.COMPLETE_OK);
>         this._cps._broadcastPrefSet(group, name, value);
>       });
>-      return;
>+      return pseudoPending;
>     }
> 
>     // Invalidate the cached value so consumers accessing the cache between now
>     // and when the operation finishes don't get old data.
>     this._cache.remove(group, name);
> 
>     let stmts = [];
> 
>@@ -255,17 +262,17 @@ ContentPrefService2.prototype = {
>           ":value",
>         ")"
>       );
>     }
>     stmt.params.name = name;
>     stmt.params.value = value;
>     stmts.push(stmt);
> 
>-    this._execStmts(stmts, {
>+    return this._execStmts(stmts, {
>       onDone: function onDone(reason, ok) {
>         if (ok)
>           this._cache.setWithCast(group, name, value);
>         cbHandleCompletion(callback, reason);
>         if (ok)
>           this._cps._broadcastPrefSet(group, name, value);
>       },
>       onError: function onError(nsresult) {
>@@ -273,28 +280,28 @@ ContentPrefService2.prototype = {
>       }
>     });
>   },
> 
>   removeByDomainAndName: function CPS2_removeByDomainAndName(group, name,
>                                                              context,
>                                                              callback) {
>     checkGroupArg(group);
>-    this._remove(group, name, false, context, callback);
>+    return this._remove(group, name, false, context, callback);
>   },
> 
>   removeBySubdomainAndName: function CPS2_removeBySubdomainAndName(group, name,
>                                                                    context,
>                                                                    callback) {
>     checkGroupArg(group);
>-    this._remove(group, name, true, context, callback);
>+    return this._remove(group, name, true, context, callback);
>   },
> 
>   removeGlobal: function CPS2_removeGlobal(name, context,callback) {
>-    this._remove(null, name, false, context, callback);
>+    return this._remove(null, name, false, context, callback);
>   },
> 
>   _remove: function CPS2__remove(group, name, includeSubdomains, context,
>                                  callback) {
>     group = this._parseGroup(group);
>     checkNameArg(name);
>     checkCallbackArg(callback, false);
> 
>@@ -331,24 +338,26 @@ ContentPrefService2.prototype = {
>     stmts.push(this._stmt(
>       "DELETE FROM groups WHERE id NOT IN (",
>         "SELECT DISTINCT groupID FROM prefs WHERE groupID NOTNULL",
>       ")"
>     ));
> 
>     let prefs = new ContentPrefStore();
> 
>-    this._execStmts(stmts, {
>+    return this._execStmts(stmts, {
>       onRow: function onRow(row) {
>         let grp = row.getResultByName("grp");
>         prefs.set(grp, name, undefined);
>-        this._cache.set(grp, name, undefined);
>       },
>       onDone: function onDone(reason, ok) {
>         if (ok) {
>+          for (let [sgroup, , ] in prefs) {
>+            this._cache.set(sgroup, name, undefined);
>+          }
>           this._cache.set(group, name, undefined);
>           if (context && context.usePrivateBrowsing) {
>             for (let [sgroup, ] in
>                    this._pbStore.match(group, name, includeSubdomains)) {
>               prefs.set(sgroup, name, undefined);
>               this._pbStore.remove(sgroup, name);
>             }
>           }
>@@ -363,26 +372,26 @@ ContentPrefService2.prototype = {
>       onError: function onError(nsresult) {
>         cbHandleError(callback, nsresult);
>       }
>     });
>   },
> 
>   removeByDomain: function CPS2_removeByDomain(group, context, callback) {
>     checkGroupArg(group);
>-    this._removeByDomain(group, false, context, callback);
>+    return this._removeByDomain(group, false, context, callback);
>   },
> 
>   removeBySubdomain: function CPS2_removeBySubdomain(group, context, callback) {
>     checkGroupArg(group);
>-    this._removeByDomain(group, true, context, callback);
>+    return this._removeByDomain(group, true, context, callback);
>   },
> 
>   removeAllGlobals: function CPS2_removeAllGlobals(context, callback) {
>-    this._removeByDomain(null, false, context, callback);
>+    return this._removeByDomain(null, false, context, callback);
>   },
> 
>   _removeByDomain: function CPS2__removeByDomain(group, includeSubdomains,
>                                                  context, callback) {
>     group = this._parseGroup(group);
>     checkCallbackArg(callback, false);
> 
>     // Invalidate the cached values so consumers accessing the cache between now
>@@ -426,28 +435,32 @@ ContentPrefService2.prototype = {
>     // Finally delete settings that are no longer referenced.
>     stmts.push(this._stmt(
>       "DELETE FROM settings",
>       "WHERE id NOT IN (SELECT DISTINCT settingID FROM prefs)"
>     ));
> 
>     let prefs = new ContentPrefStore();
> 
>-    this._execStmts(stmts, {
>+    return this._execStmts(stmts, {
>       onRow: function onRow(row) {
>         let grp = row.getResultByName("grp");
>         let name = row.getResultByName("name");
>         prefs.set(grp, name, undefined);
>-        this._cache.set(grp, name, undefined);
>       },
>       onDone: function onDone(reason, ok) {
>-        if (ok && context && context.usePrivateBrowsing) {
>-          for (let [sgroup, sname, ] in this._pbStore) {
>-            prefs.set(sgroup, sname, undefined);
>-            this._pbStore.remove(sgroup, sname);
>+        if (ok) {
>+          for (let [sgroup, sname, ] in prefs) {
>+            this._cache.set(sgroup, sname, undefined);
>+          }
>+          if (context && context.usePrivateBrowsing) {
>+            for (let [sgroup, sname, ] in this._pbStore) {
>+              prefs.set(sgroup, sname, undefined);
>+              this._pbStore.remove(sgroup, sname);
>+            }
>           }
>         }
>         cbHandleCompletion(callback, reason);
>         if (ok) {
>           for (let [sgroup, sname, ] in prefs) {
>             this._cps._broadcastPrefRemoved(sgroup, sname);
>           }
>         }
>@@ -483,29 +496,33 @@ ContentPrefService2.prototype = {
>     ));
>     stmts.push(this._stmt(
>       "DELETE FROM settings",
>       "WHERE id NOT IN (SELECT DISTINCT settingID FROM prefs)"
>     ));
> 
>     let prefs = new ContentPrefStore();
> 
>-    this._execStmts(stmts, {
>+    return this._execStmts(stmts, {
>       onRow: function onRow(row) {
>         let grp = row.getResultByName("grp");
>         let name = row.getResultByName("name");
>         prefs.set(grp, name, undefined);
>-        this._cache.set(grp, name, undefined);
>       },
>       onDone: function onDone(reason, ok) {
>-        if (ok && context && context.usePrivateBrowsing) {
>-          for (let [sgroup, sname, ] in this._pbStore) {
>-            prefs.set(sgroup, sname, undefined);
>+        if (ok) {
>+          for (let [sgroup, sname, ] in prefs) {
>+            this._cache.set(sgroup, sname, undefined);
>           }
>-          this._pbStore.removeAllGroups();
>+          if (context && context.usePrivateBrowsing) {
>+            for (let [sgroup, sname, ] in this._pbStore) {
>+              prefs.set(sgroup, sname, undefined);
>+            }
>+            this._pbStore.removeAllGroups();
>+          }
>         }
>         cbHandleCompletion(callback, reason);
>         if (ok) {
>           for (let [sgroup, sname, ] in prefs) {
>             this._cps._broadcastPrefRemoved(sgroup, sname);
>           }
>         }
>       },
>@@ -562,28 +579,32 @@ ContentPrefService2.prototype = {
>     stmts.push(this._stmt(
>       "DELETE FROM groups WHERE id NOT IN (",
>         "SELECT DISTINCT groupID FROM prefs WHERE groupID NOTNULL",
>       ")"
>     ));
> 
>     let prefs = new ContentPrefStore();
> 
>-    this._execStmts(stmts, {
>+    return this._execStmts(stmts, {
>       onRow: function onRow(row) {
>         let grp = row.getResultByName("grp");
>         prefs.set(grp, name, undefined);
>-        this._cache.set(grp, name, undefined);
>       },
>       onDone: function onDone(reason, ok) {
>-        if (ok && context && context.usePrivateBrowsing) {
>-          for (let [sgroup, sname, ] in this._pbStore) {
>-            if (sname === name) {
>-              prefs.set(sgroup, name, undefined);
>-              this._pbStore.remove(sgroup, name);
>+        if (ok) {
>+          for (let [sgroup, , ] in prefs) {
>+            this._cache.set(sgroup, name, undefined);
>+          }
>+          if (context && context.usePrivateBrowsing) {
>+            for (let [sgroup, sname, ] in this._pbStore) {
>+              if (sname === name) {
>+                prefs.set(sgroup, name, undefined);
>+                this._pbStore.remove(sgroup, name);
>+              }
>             }
>           }
>         }
>         cbHandleCompletion(callback, reason);
>         if (ok) {
>           for (let [sgroup, , ] in prefs) {
>             this._cps._broadcastPrefRemoved(sgroup, name);
>           }
>@@ -631,56 +652,61 @@ ContentPrefService2.prototype = {
>    *                   onDone(reason, reasonOK, didGetRow) (required)
>    *                     Called when done.
>    *                     reason: A nsIContentPrefService2.COMPLETE_* value.
>    *                     reasonOK: reason == nsIContentPrefService2.COMPLETE_OK.
>    *                     didGetRow: True if onRow was ever called.
>    *                   onError(nsresult) (optional)
>    *                     Called on error.
>    *                     nsresult: The error code.
>+   * @return StoragePending
>    */
>   _execStmts: function CPS2__execStmts(stmts, callbacks) {
>     let self = this;
>     let gotRow = false;
>-    this._cps._dbConnection.executeAsync(stmts, stmts.length, {
>+    let pending = this._cps._dbConnection.executeAsync(stmts, stmts.length, {
>       handleResult: function handleResult(results) {
>         try {
>           let row = null;
>           while ((row = results.getNextRow())) {
>             gotRow = true;
>             if (callbacks.onRow)
>               callbacks.onRow.call(self, row);
>           }
>         }
>         catch (err) {
>           Cu.reportError(err);
>         }
>       },
>       handleCompletion: function handleCompletion(reason) {
>         try {
>-          let ok = reason == Ci.mozIStorageStatementCallback.REASON_FINISHED;
>-          callbacks.onDone.call(self,
>-                                ok ? Ci.nsIContentPrefCallback2.COMPLETE_OK :
>-                                  Ci.nsIContentPrefCallback2.COMPLETE_ERROR,
>-                                ok, gotRow);
>+          let cpsReason =
>+            reason == Ci.mozIStorageStatementCallback.REASON_FINISHED ?
>+              Ci.nsIContentPrefCallback2.COMPLETE_OK :
>+            reason == Ci.mozIStorageStatementCallback.REASON_CANCELED ?
>+              Ci.nsIContentPrefCallback2.COMPLETE_CANCELED :
>+            Ci.nsIContentPrefCallback2.COMPLETE_ERROR;
>+          let ok = cpsReason == Ci.nsIContentPrefCallback2.COMPLETE_OK;
>+          callbacks.onDone.call(self, cpsReason, ok, gotRow);
>         }
>         catch (err) {
>           Cu.reportError(err);
>         }
>       },
>       handleError: function handleError(error) {
>         try {
>           if (callbacks.onError)
>             callbacks.onError.call(self, Cr.NS_ERROR_FAILURE);
>         }
>         catch (err) {
>           Cu.reportError(err);
>         }
>       }
>     });
>+    return new StoragePending(pending);
>   },
> 
>   /**
>    * Parses the domain (the "group", to use the database's term) from the given
>    * string.
>    *
>    * @param groupStr  Assumed to be either a string or falsey.
>    * @return          If groupStr is a valid URL string, returns the domain of
>@@ -825,8 +851,30 @@ function checkCallbackArg(callback, requ
> 
> function invalidArg(msg) {
>   return Components.Exception(msg, Cr.NS_ERROR_INVALID_ARG);
> }
> 
> function joinArgs(args) {
>   return Array.join(args, " ").trim().replace(/\s{2,}/g, " ");
> }
>+
>+function StoragePending(pending) {
>+  this._pending = pending;
>+}
>+
>+StoragePending.prototype = {
>+  cancel: function StoragePending_cancel() {
>+    this._pending.cancel();
>+  },
>+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIContentPrefPending]),
>+};
>+
>+function PseudoPending() {
>+  this.canceled = false;
>+}
>+
>+PseudoPending.prototype = {
>+  cancel: function StoragePending_cancel() {
>+    this.canceled = true;
>+  },
>+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIContentPrefPending]),
>+};
>diff --git a/toolkit/components/contentprefs/tests/unit_cps2/head.js b/toolkit/components/contentprefs/tests/unit_cps2/head.js
>--- a/toolkit/components/contentprefs/tests/unit_cps2/head.js
>+++ b/toolkit/components/contentprefs/tests/unit_cps2/head.js
>@@ -153,17 +153,18 @@ function getGlobalOK(args, expectedVal) 
>   yield getOKEx("getGlobal", args, expectedPrefs);
> }
> 
> function getOKEx(methodName, args, expectedPrefs, strict, context) {
>   let actualPrefs = [];
>   args.push(makeCallback({
>     handleResult: function (pref) actualPrefs.push(pref)
>   }));
>-  yield cps[methodName].apply(cps, args);
>+  cps[methodName].apply(cps, args);
>+  yield;
>   arraysOfArraysOK([actualPrefs], [expectedPrefs], function (actual, expected) {
>     prefOK(actual, expected, strict);
>   });
> }
> 
> function getCachedOK(args, expectedIsCached, expectedVal, expectedGroup,
>                      strict) {
>   if (args.length == 2)
>diff --git a/toolkit/components/contentprefs/tests/unit_cps2/test_getCachedSubdomains.js b/toolkit/components/contentprefs/tests/unit_cps2/test_getCachedSubdomains.js
>--- a/toolkit/components/contentprefs/tests/unit_cps2/test_getCachedSubdomains.js
>+++ b/toolkit/components/contentprefs/tests/unit_cps2/test_getCachedSubdomains.js
>@@ -42,116 +42,131 @@ let tests = [
>   function subdomains() {
>     yield set("a.com", "foo", 1);
>     yield set("b.a.com", "foo", 2);
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", 1], ["b.a.com", 2]]);
>     getCachedSubdomainsOK(["b.a.com", "foo"], [["b.a.com", 2]]);
>   },
> 
>   function populateViaGet() {
>-    yield cps.getByDomainAndName("a.com", "foo", null, makeCallback());
>+    cps.getByDomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
> 
>-    yield cps.getGlobal("foo", null, makeCallback());
>+    cps.getGlobal("foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
>     getCachedGlobalOK(["foo"], true, undefined);
>   },
> 
>   function populateViaGetSubdomains() {
>-    yield cps.getBySubdomainAndName("a.com", "foo", null, makeCallback());
>+    cps.getBySubdomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
>   },
> 
>   function populateViaRemove() {
>-    yield cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
> 
>-    yield cps.removeBySubdomainAndName("b.com", "foo", null, makeCallback());
>+    cps.removeBySubdomainAndName("b.com", "foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
>     getCachedSubdomainsOK(["b.com", "foo"], [["b.com", undefined]]);
> 
>-    yield cps.removeGlobal("foo", null, makeCallback());
>+    cps.removeGlobal("foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
>     getCachedSubdomainsOK(["b.com", "foo"], [["b.com", undefined]]);
>     getCachedGlobalOK(["foo"], true, undefined);
> 
>     yield set("a.com", "foo", 1);
>-    yield cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
>     getCachedSubdomainsOK(["b.com", "foo"], [["b.com", undefined]]);
>     getCachedGlobalOK(["foo"], true, undefined);
> 
>     yield set("a.com", "foo", 2);
>     yield set("b.a.com", "foo", 3);
>-    yield cps.removeBySubdomainAndName("a.com", "foo", null, makeCallback());
>+    cps.removeBySubdomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"],
>                           [["a.com", undefined], ["b.a.com", undefined]]);
>     getCachedSubdomainsOK(["b.com", "foo"], [["b.com", undefined]]);
>     getCachedGlobalOK(["foo"], true, undefined);
>     getCachedSubdomainsOK(["b.a.com", "foo"], [["b.a.com", undefined]]);
> 
>     yield setGlobal("foo", 4);
>-    yield cps.removeGlobal("foo", null, makeCallback());
>+    cps.removeGlobal("foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"],
>                           [["a.com", undefined], ["b.a.com", undefined]]);
>     getCachedSubdomainsOK(["b.com", "foo"], [["b.com", undefined]]);
>     getCachedGlobalOK(["foo"], true, undefined);
>     getCachedSubdomainsOK(["b.a.com", "foo"], [["b.a.com", undefined]]);
>   },
> 
>   function populateViaRemoveByDomain() {
>     yield set("a.com", "foo", 1);
>     yield set("a.com", "bar", 2);
>     yield set("b.a.com", "foo", 3);
>     yield set("b.a.com", "bar", 4);
>-    yield cps.removeByDomain("a.com", null, makeCallback());
>+    cps.removeByDomain("a.com", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"],
>                           [["a.com", undefined], ["b.a.com", 3]]);
>     getCachedSubdomainsOK(["a.com", "bar"],
>                           [["a.com", undefined], ["b.a.com", 4]]);
> 
>     yield set("a.com", "foo", 5);
>     yield set("a.com", "bar", 6);
>-    yield cps.removeBySubdomain("a.com", null, makeCallback());
>+    cps.removeBySubdomain("a.com", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"],
>                           [["a.com", undefined], ["b.a.com", undefined]]);
>     getCachedSubdomainsOK(["a.com", "bar"],
>                           [["a.com", undefined], ["b.a.com", undefined]]);
> 
>     yield setGlobal("foo", 7);
>     yield setGlobal("bar", 8);
>-    yield cps.removeAllGlobals(null, makeCallback());
>+    cps.removeAllGlobals(null, makeCallback());
>+    yield;
>     getCachedGlobalOK(["foo"], true, undefined);
>     getCachedGlobalOK(["bar"], true, undefined);
>   },
> 
>   function populateViaRemoveAllDomains() {
>     yield set("a.com", "foo", 1);
>     yield set("a.com", "bar", 2);
>     yield set("b.com", "foo", 3);
>     yield set("b.com", "bar", 4);
>-    yield cps.removeAllDomains(null, makeCallback());
>+    cps.removeAllDomains(null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
>     getCachedSubdomainsOK(["a.com", "bar"], [["a.com", undefined]]);
>     getCachedSubdomainsOK(["b.com", "foo"], [["b.com", undefined]]);
>     getCachedSubdomainsOK(["b.com", "bar"], [["b.com", undefined]]);
>   },
> 
>   function populateViaRemoveByName() {
>     yield set("a.com", "foo", 1);
>     yield set("a.com", "bar", 2);
>     yield setGlobal("foo", 3);
>     yield setGlobal("bar", 4);
>-    yield cps.removeByName("foo", null, makeCallback());
>+    cps.removeByName("foo", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
>     getCachedSubdomainsOK(["a.com", "bar"], [["a.com", 2]]);
>     getCachedGlobalOK(["foo"], true, undefined);
>     getCachedGlobalOK(["bar"], true, 4);
> 
>-    yield cps.removeByName("bar", null, makeCallback());
>+    cps.removeByName("bar", null, makeCallback());
>+    yield;
>     getCachedSubdomainsOK(["a.com", "foo"], [["a.com", undefined]]);
>     getCachedSubdomainsOK(["a.com", "bar"], [["a.com", undefined]]);
>     getCachedGlobalOK(["foo"], true, undefined);
>     getCachedGlobalOK(["bar"], true, undefined);
>   },
> 
>   function privateBrowsing() {
>     yield set("a.com", "foo", 1);
>diff --git a/toolkit/components/contentprefs/tests/unit_cps2/test_observers.js b/toolkit/components/contentprefs/tests/unit_cps2/test_observers.js
>--- a/toolkit/components/contentprefs/tests/unit_cps2/test_observers.js
>+++ b/toolkit/components/contentprefs/tests/unit_cps2/test_observers.js
>@@ -21,83 +21,92 @@ let tests = [
>     observerArgsOK(args.null, [[null, "foo", 2]]);
>     observerArgsOK(args.bar, []);
>   },
> 
>   function observerForName_remove() {
>     yield set("a.com", "foo", 1);
>     yield setGlobal("foo", 2);
> 
>-    yield cps.removeByDomainAndName("a.com", "bogus", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "bogus", null, makeCallback());
>+    yield;
>     let args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, []);
>     observerArgsOK(args.null, []);
>     observerArgsOK(args.bar, []);
> 
>-    yield cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, [["a.com", "foo"]]);
>     observerArgsOK(args.null, [["a.com", "foo"]]);
>     observerArgsOK(args.bar, []);
> 
>-    yield cps.removeGlobal("foo", null, makeCallback());
>+    cps.removeGlobal("foo", null, makeCallback());
>+    yield;
>     args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, [[null, "foo"]]);
>     observerArgsOK(args.null, [[null, "foo"]]);
>     observerArgsOK(args.bar, []);
>   },
> 
>   function observerForName_removeByDomain() {
>     yield set("a.com", "foo", 1);
>     yield set("b.a.com", "bar", 2);
>     yield setGlobal("foo", 3);
> 
>-    yield cps.removeByDomain("bogus", null, makeCallback());
>+    cps.removeByDomain("bogus", null, makeCallback());
>+    yield;
>     let args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, []);
>     observerArgsOK(args.null, []);
>     observerArgsOK(args.bar, []);
> 
>-    yield cps.removeBySubdomain("a.com", null, makeCallback());
>+    cps.removeBySubdomain("a.com", null, makeCallback());
>+    yield;
>     args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, [["a.com", "foo"]]);
>     observerArgsOK(args.null, [["a.com", "foo"], ["b.a.com", "bar"]]);
>     observerArgsOK(args.bar, [["b.a.com", "bar"]]);
> 
>-    yield cps.removeAllGlobals(null, makeCallback());
>+    cps.removeAllGlobals(null, makeCallback());
>+    yield;
>     args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, [[null, "foo"]]);
>     observerArgsOK(args.null, [[null, "foo"]]);
>     observerArgsOK(args.bar, []);
>   },
> 
>   function observerForName_removeAllDomains() {
>     yield set("a.com", "foo", 1);
>     yield setGlobal("foo", 2);
>     yield set("b.com", "bar", 3);
> 
>-    yield cps.removeAllDomains(null, makeCallback());
>+    cps.removeAllDomains(null, makeCallback());
>+    yield;
>     let args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, [["a.com", "foo"]]);
>     observerArgsOK(args.null, [["a.com", "foo"], ["b.com", "bar"]]);
>     observerArgsOK(args.bar, [["b.com", "bar"]]);
>   },
> 
>   function observerForName_removeByName() {
>     yield set("a.com", "foo", 1);
>     yield set("a.com", "bar", 2);
>     yield setGlobal("foo", 3);
> 
>-    yield cps.removeByName("bogus", null, makeCallback());
>+    cps.removeByName("bogus", null, makeCallback());
>+    yield;
>     let args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, []);
>     observerArgsOK(args.null, []);
>     observerArgsOK(args.bar, []);
> 
>-    yield cps.removeByName("foo", null, makeCallback());
>+    cps.removeByName("foo", null, makeCallback());
>+    yield;
>     args = yield on("Removed", ["foo", null, "bar"]);
>     observerArgsOK(args.foo, [["a.com", "foo"], [null, "foo"]]);
>     observerArgsOK(args.null, [["a.com", "foo"], [null, "foo"]]);
>     observerArgsOK(args.bar, []);
>   },
> 
>   function removeObserverForName() {
>     let args = yield on("Set", ["foo", null, "bar"], true);
>diff --git a/toolkit/components/contentprefs/tests/unit_cps2/test_remove.js b/toolkit/components/contentprefs/tests/unit_cps2/test_remove.js
>--- a/toolkit/components/contentprefs/tests/unit_cps2/test_remove.js
>+++ b/toolkit/components/contentprefs/tests/unit_cps2/test_remove.js
>@@ -7,135 +7,148 @@ function run_test() {
> }
> 
> let tests = [
> 
>   function nonexistent() {
>     yield set("a.com", "foo", 1);
>     yield setGlobal("foo", 2);
> 
>-    yield cps.removeByDomainAndName("a.com", "bogus", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "bogus", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 1],
>       [null, "foo", 2],
>     ]);
>     yield getOK(["a.com", "foo"], 1);
>     yield getGlobalOK(["foo"], 2);
> 
>-    yield cps.removeBySubdomainAndName("a.com", "bogus", null, makeCallback());
>+    cps.removeBySubdomainAndName("a.com", "bogus", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 1],
>       [null, "foo", 2],
>     ]);
>     yield getOK(["a.com", "foo"], 1);
>     yield getGlobalOK(["foo"], 2);
> 
>-    yield cps.removeGlobal("bogus", null, makeCallback());
>+    cps.removeGlobal("bogus", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 1],
>       [null, "foo", 2],
>     ]);
>     yield getOK(["a.com", "foo"], 1);
>     yield getGlobalOK(["foo"], 2);
> 
>-    yield cps.removeByDomainAndName("bogus", "bogus", null, makeCallback());
>+    cps.removeByDomainAndName("bogus", "bogus", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 1],
>       [null, "foo", 2],
>     ]);
>     yield getOK(["a.com", "foo"], 1);
>     yield getGlobalOK(["foo"], 2);
>   },
> 
>   function isomorphicDomains() {
>     yield set("a.com", "foo", 1);
>-    yield cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     yield dbOK([]);
>     yield getOK(["a.com", "foo"], undefined);
> 
>     yield set("a.com", "foo", 2);
>-    yield cps.removeByDomainAndName("http://a.com/huh", "foo", null,
>-                                    makeCallback());
>+    cps.removeByDomainAndName("http://a.com/huh", "foo", null, makeCallback());
>+    yield;
>     yield dbOK([]);
>     yield getOK(["a.com", "foo"], undefined);
>   },
> 
>   function names() {
>     yield set("a.com", "foo", 1);
>     yield set("a.com", "bar", 2);
>     yield setGlobal("foo", 3);
>     yield setGlobal("bar", 4);
> 
>-    yield cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "bar", 2],
>       [null, "foo", 3],
>       [null, "bar", 4],
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], 2);
>     yield getGlobalOK(["foo"], 3);
>     yield getGlobalOK(["bar"], 4);
> 
>-    yield cps.removeGlobal("foo", null, makeCallback());
>+    cps.removeGlobal("foo", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "bar", 2],
>       [null, "bar", 4],
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], 2);
>     yield getGlobalOK(["foo"], undefined);
>     yield getGlobalOK(["bar"], 4);
> 
>-    yield cps.removeByDomainAndName("a.com", "bar", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "bar", null, makeCallback());
>+    yield;
>     yield dbOK([
>       [null, "bar", 4],
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], undefined);
>     yield getGlobalOK(["foo"], undefined);
>     yield getGlobalOK(["bar"], 4);
> 
>-    yield cps.removeGlobal("bar", null, makeCallback());
>+    cps.removeGlobal("bar", null, makeCallback());
>+    yield;
>     yield dbOK([
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], undefined);
>     yield getGlobalOK(["foo"], undefined);
>     yield getGlobalOK(["bar"], undefined);
>   },
> 
>   function subdomains() {
>     yield set("a.com", "foo", 1);
>     yield set("b.a.com", "foo", 2);
>-    yield cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    cps.removeByDomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["b.a.com", "foo", 2],
>     ]);
>     yield getSubdomainsOK(["a.com", "foo"], [["b.a.com", 2]]);
>     yield getSubdomainsOK(["b.a.com", "foo"], [["b.a.com", 2]]);
> 
>     yield set("a.com", "foo", 3);
>-    yield cps.removeBySubdomainAndName("a.com", "foo", null, makeCallback());
>+    cps.removeBySubdomainAndName("a.com", "foo", null, makeCallback());
>+    yield;
>     yield dbOK([
>     ]);
>     yield getSubdomainsOK(["a.com", "foo"], []);
>     yield getSubdomainsOK(["b.a.com", "foo"], []);
> 
>     yield set("a.com", "foo", 4);
>     yield set("b.a.com", "foo", 5);
>-    yield cps.removeByDomainAndName("b.a.com", "foo", null, makeCallback());
>+    cps.removeByDomainAndName("b.a.com", "foo", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 4],
>     ]);
>     yield getSubdomainsOK(["a.com", "foo"], [["a.com", 4]]);
>     yield getSubdomainsOK(["b.a.com", "foo"], []);
> 
>     yield set("b.a.com", "foo", 6);
>-    yield cps.removeBySubdomainAndName("b.a.com", "foo", null, makeCallback());
>+    cps.removeBySubdomainAndName("b.a.com", "foo", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 4],
>     ]);
>     yield getSubdomainsOK(["a.com", "foo"], [["a.com", 4]]);
>     yield getSubdomainsOK(["b.a.com", "foo"], []);
>   },
> 
>   function privateBrowsing() {
>@@ -145,20 +158,24 @@ let tests = [
>     yield setGlobal("bar", 4);
>     yield setGlobal("qux", 5);
>     yield set("b.com", "foo", 6);
>     yield set("b.com", "bar", 7);
> 
>     let context = { usePrivateBrowsing: true };
>     yield set("a.com", "foo", 8, context);
>     yield setGlobal("foo", 9, context);
>-    yield cps.removeByDomainAndName("a.com", "foo", context, makeCallback());
>-    yield cps.removeGlobal("foo", context, makeCallback());
>-    yield cps.removeGlobal("qux", context, makeCallback());
>-    yield cps.removeByDomainAndName("b.com", "foo", context, makeCallback());
>+    cps.removeByDomainAndName("a.com", "foo", context, makeCallback());
>+    yield;
>+    cps.removeGlobal("foo", context, makeCallback());
>+    yield;
>+    cps.removeGlobal("qux", context, makeCallback());
>+    yield;
>+    cps.removeByDomainAndName("b.com", "foo", context, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "bar", 2],
>       [null, "bar", 4],
>       ["b.com", "bar", 7],
>     ]);
>     yield getOK(["a.com", "foo", context], undefined);
>     yield getOK(["a.com", "bar", context], 2);
>     yield getGlobalOK(["foo", context], undefined);
>diff --git a/toolkit/components/contentprefs/tests/unit_cps2/test_removeAllDomains.js b/toolkit/components/contentprefs/tests/unit_cps2/test_removeAllDomains.js
>--- a/toolkit/components/contentprefs/tests/unit_cps2/test_removeAllDomains.js
>+++ b/toolkit/components/contentprefs/tests/unit_cps2/test_removeAllDomains.js
>@@ -5,32 +5,34 @@
> function run_test() {
>   runAsyncTests(tests);
> }
> 
> let tests = [
> 
>   function nonexistent() {
>     yield setGlobal("foo", 1);
>-    yield cps.removeAllDomains(null, makeCallback());
>+    cps.removeAllDomains(null, makeCallback());
>+    yield;
>     yield dbOK([
>       [null, "foo", 1],
>     ]);
>     yield getGlobalOK(["foo"], 1);
>   },
> 
>   function domains() {
>     yield set("a.com", "foo", 1);
>     yield set("a.com", "bar", 2);
>     yield setGlobal("foo", 3);
>     yield setGlobal("bar", 4);
>     yield set("b.com", "foo", 5);
>     yield set("b.com", "bar", 6);
> 
>-    yield cps.removeAllDomains(null, makeCallback());
>+    cps.removeAllDomains(null, makeCallback());
>+    yield;
>     yield dbOK([
>       [null, "foo", 3],
>       [null, "bar", 4],
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], undefined);
>     yield getGlobalOK(["foo"], 3);
>     yield getGlobalOK(["bar"], 4);
>@@ -43,17 +45,18 @@ let tests = [
>     yield set("a.com", "bar", 2);
>     yield setGlobal("foo", 3);
>     yield setGlobal("bar", 4);
>     yield set("b.com", "foo", 5);
> 
>     let context = { usePrivateBrowsing: true };
>     yield set("a.com", "foo", 6, context);
>     yield setGlobal("foo", 7, context);
>-    yield cps.removeAllDomains(context, makeCallback());
>+    cps.removeAllDomains(context, makeCallback());
>+    yield;
>     yield dbOK([
>       [null, "foo", 3],
>       [null, "bar", 4],
>     ]);
>     yield getOK(["a.com", "foo", context], undefined);
>     yield getOK(["a.com", "bar", context], undefined);
>     yield getGlobalOK(["foo", context], 7);
>     yield getGlobalOK(["bar", context], 4);
>diff --git a/toolkit/components/contentprefs/tests/unit_cps2/test_removeByDomain.js b/toolkit/components/contentprefs/tests/unit_cps2/test_removeByDomain.js
>--- a/toolkit/components/contentprefs/tests/unit_cps2/test_removeByDomain.js
>+++ b/toolkit/components/contentprefs/tests/unit_cps2/test_removeByDomain.js
>@@ -7,118 +7,129 @@ function run_test() {
> }
> 
> let tests = [
> 
>   function nonexistent() {
>     yield set("a.com", "foo", 1);
>     yield setGlobal("foo", 2);
> 
>-    yield cps.removeByDomain("bogus", null, makeCallback());
>+    cps.removeByDomain("bogus", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 1],
>       [null, "foo", 2],
>     ]);
>     yield getOK(["a.com", "foo"], 1);
>     yield getGlobalOK(["foo"], 2);
> 
>-    yield cps.removeBySubdomain("bogus", null, makeCallback());
>+    cps.removeBySubdomain("bogus", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 1],
>       [null, "foo", 2],
>     ]);
>     yield getOK(["a.com", "foo"], 1);
>     yield getGlobalOK(["foo"], 2);
>   },
> 
>   function isomorphicDomains() {
>     yield set("a.com", "foo", 1);
>-    yield cps.removeByDomain("a.com", null, makeCallback());
>+    cps.removeByDomain("a.com", null, makeCallback());
>+    yield;
>     yield dbOK([]);
>     yield getOK(["a.com", "foo"], undefined);
> 
>     yield set("a.com", "foo", 2);
>-    yield cps.removeByDomain("http://a.com/huh", null, makeCallback());
>+    cps.removeByDomain("http://a.com/huh", null, makeCallback());
>+    yield;
>     yield dbOK([]);
>     yield getOK(["a.com", "foo"], undefined);
>   },
> 
>   function domains() {
>     yield set("a.com", "foo", 1);
>     yield set("a.com", "bar", 2);
>     yield setGlobal("foo", 3);
>     yield setGlobal("bar", 4);
>     yield set("b.com", "foo", 5);
>     yield set("b.com", "bar", 6);
> 
>-    yield cps.removeByDomain("a.com", null, makeCallback());
>+    cps.removeByDomain("a.com", null, makeCallback());
>+    yield;
>     yield dbOK([
>       [null, "foo", 3],
>       [null, "bar", 4],
>       ["b.com", "foo", 5],
>       ["b.com", "bar", 6],
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], undefined);
>     yield getGlobalOK(["foo"], 3);
>     yield getGlobalOK(["bar"], 4);
>     yield getOK(["b.com", "foo"], 5);
>     yield getOK(["b.com", "bar"], 6);
> 
>-    yield cps.removeAllGlobals(null, makeCallback());
>+    cps.removeAllGlobals(null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["b.com", "foo", 5],
>       ["b.com", "bar", 6],
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], undefined);
>     yield getGlobalOK(["foo"], undefined);
>     yield getGlobalOK(["bar"], undefined);
>     yield getOK(["b.com", "foo"], 5);
>     yield getOK(["b.com", "bar"], 6);
> 
>-    yield cps.removeByDomain("b.com", null, makeCallback());
>+    cps.removeByDomain("b.com", null, makeCallback());
>+    yield;
>     yield dbOK([
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], undefined);
>     yield getGlobalOK(["foo"], undefined);
>     yield getGlobalOK(["bar"], undefined);
>     yield getOK(["b.com", "foo"], undefined);
>     yield getOK(["b.com", "bar"], undefined);
>   },
> 
>   function subdomains() {
>     yield set("a.com", "foo", 1);
>     yield set("b.a.com", "foo", 2);
>-    yield cps.removeByDomain("a.com", null, makeCallback());
>+    cps.removeByDomain("a.com", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["b.a.com", "foo", 2],
>     ]);
>     yield getSubdomainsOK(["a.com", "foo"], [["b.a.com", 2]]);
>     yield getSubdomainsOK(["b.a.com", "foo"], [["b.a.com", 2]]);
> 
>     yield set("a.com", "foo", 3);
>-    yield cps.removeBySubdomain("a.com", null, makeCallback());
>+    cps.removeBySubdomain("a.com", null, makeCallback());
>+    yield;
>     yield dbOK([
>     ]);
>     yield getSubdomainsOK(["a.com", "foo"], []);
>     yield getSubdomainsOK(["b.a.com", "foo"], []);
> 
>     yield set("a.com", "foo", 4);
>     yield set("b.a.com", "foo", 5);
>-    yield cps.removeByDomain("b.a.com", null, makeCallback());
>+    cps.removeByDomain("b.a.com", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 4],
>     ]);
>     yield getSubdomainsOK(["a.com", "foo"], [["a.com", 4]]);
>     yield getSubdomainsOK(["b.a.com", "foo"], []);
> 
>     yield set("b.a.com", "foo", 6);
>-    yield cps.removeBySubdomain("b.a.com", null, makeCallback());
>+    cps.removeBySubdomain("b.a.com", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 4],
>     ]);
>     yield getSubdomainsOK(["a.com", "foo"], [["a.com", 4]]);
>     yield getSubdomainsOK(["b.a.com", "foo"], []);
>   },
> 
>   function privateBrowsing() {
>@@ -126,18 +137,20 @@ let tests = [
>     yield set("a.com", "bar", 2);
>     yield setGlobal("foo", 3);
>     yield setGlobal("bar", 4);
>     yield set("b.com", "foo", 5);
> 
>     let context = { usePrivateBrowsing: true };
>     yield set("a.com", "foo", 6, context);
>     yield setGlobal("foo", 7, context);
>-    yield cps.removeByDomain("a.com", context, makeCallback());
>-    yield cps.removeAllGlobals(context, makeCallback());
>+    cps.removeByDomain("a.com", context, makeCallback());
>+    yield;
>+    cps.removeAllGlobals(context, makeCallback());
>+    yield;
>     yield dbOK([
>       ["b.com", "foo", 5],
>     ]);
>     yield getOK(["a.com", "foo", context], undefined);
>     yield getOK(["a.com", "bar", context], undefined);
>     yield getGlobalOK(["foo", context], undefined);
>     yield getGlobalOK(["bar", context], undefined);
>     yield getOK(["b.com", "foo", context], 5);
>diff --git a/toolkit/components/contentprefs/tests/unit_cps2/test_removeByName.js b/toolkit/components/contentprefs/tests/unit_cps2/test_removeByName.js
>--- a/toolkit/components/contentprefs/tests/unit_cps2/test_removeByName.js
>+++ b/toolkit/components/contentprefs/tests/unit_cps2/test_removeByName.js
>@@ -7,34 +7,36 @@ function run_test() {
> }
> 
> let tests = [
> 
>   function nonexistent() {
>     yield set("a.com", "foo", 1);
>     yield setGlobal("foo", 2);
> 
>-    yield cps.removeByName("bogus", null, makeCallback());
>+    cps.removeByName("bogus", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 1],
>       [null, "foo", 2],
>     ]);
>     yield getOK(["a.com", "foo"], 1);
>     yield getGlobalOK(["foo"], 2);
>   },
> 
>   function names() {
>     yield set("a.com", "foo", 1);
>     yield set("a.com", "bar", 2);
>     yield setGlobal("foo", 3);
>     yield setGlobal("bar", 4);
>     yield set("b.com", "foo", 5);
>     yield set("b.com", "bar", 6);
> 
>-    yield cps.removeByName("foo", null, makeCallback());
>+    cps.removeByName("foo", null, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "bar", 2],
>       [null, "bar", 4],
>       ["b.com", "bar", 6],
>     ]);
>     yield getOK(["a.com", "foo"], undefined);
>     yield getOK(["a.com", "bar"], 2);
>     yield getGlobalOK(["foo"], undefined);
>@@ -50,17 +52,18 @@ let tests = [
>     yield setGlobal("bar", 4);
>     yield set("b.com", "foo", 5);
>     yield set("b.com", "bar", 6);
> 
>     let context = { usePrivateBrowsing: true };
>     yield set("a.com", "foo", 7, context);
>     yield setGlobal("foo", 8, context);
>     yield set("b.com", "bar", 9, context);
>-    yield cps.removeByName("bar", context, makeCallback());
>+    cps.removeByName("bar", context, makeCallback());
>+    yield;
>     yield dbOK([
>       ["a.com", "foo", 1],
>       [null, "foo", 3],
>       ["b.com", "foo", 5],
>     ]);
>     yield getOK(["a.com", "foo", context], 7);
>     yield getOK(["a.com", "bar", context], undefined);
>     yield getGlobalOK(["foo", context], 8);
Oh jeez, sorry for comment 176.
Gijs
https://tbpl.mozilla.org/php/getParsedLog.php?id=24431155&tree=UX
Rev5 MacOSX Mountain Lion 10.8 ux opt test mochitest-browser-chrome on 2013-06-21 09:52:42
revision: 49e160b46dad
slave: talos-mtnlion-r5-040

09:55:49  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
09:55:49  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=24442239&tree=UX
Windows XP 32-bit ux pgo test mochitest-browser-chrome on 2013-06-21 15:20:21
revision: 49e160b46dad
slave: t-xp32-ix-077

15:22:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858
15:22:11  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug386835.js | Tab 2 should be zoomed now - Got 1, expected 1.100000023841858
Created attachment 766227
tokens again

This uses a token per browser like comment 175 says, plus the important changes mentioned in comment 106.  One other change is to make "browser" method parameters required instead of optional and falling back to gBrowser.selectedBrowser.  When they're optional it's harder to reason about async paths, and it's more bug prone.

Try looks good so far: https://tbpl.mozilla.org/?tree=Try&rev=8882b26ac4e5
(In reply to Drew Willcoxon :adw from comment #175)
> Hmm, I'll have to think about that.  My initial impression is that queues
> sound unnecessary when you could simply keep a monotonic token per domain. 

Per browser I meant.
Comment on attachment 766227
tokens again

Review of attachment 766227:
-----------------------------------------------------------------

I have some suggestions/questions, but the changes look doing what they are expected to do regardless my comments.

::: browser/base/content/browser-fullZoom.js
@@ +25,5 @@
>  
> +  // This maps browser outer window IDs to monotonically increasing integer
> +  // tokens.  _browserTokens[outerID] is increased each time the zoom is changed
> +  // in the browser whose outer window ID is outerID.  See _getBrowserToken.
> +  _browserTokens: {},

not very important, so you can ignore me here, though for this kind of mapping may be nicer to use a proper Map(), mostly for the API clarity of map.has(key) instead of (key in object), and map.delete(key) vs delete object[prop]
(calling this _browserTokenMap would make that nicer too)

Or you may even use a WeakMap with the dom window as the key, then you might actually stop caring about removing entries from it, since they would expire naturally. Just be sure to not use XUL objects as the keys, only DOM objects are supported.

@@ +213,3 @@
>        handleResult: function () hasPref = true,
>        handleCompletion: function () {
> +        if (token.isCurrent && !hasPref)

nit: not sure why you inverted the conditions, hasPref should still be a faster check, even if by nanoseconds :)

@@ +213,4 @@
>        handleResult: function () hasPref = true,
>        handleCompletion: function () {
> +        if (token.isCurrent && !hasPref)
> +          this._applyPrefToZoom(undefined, browser, { token: token });

I have a doubt, before any call to applyPrefToZoom you always check token.isCurrent, both here and in onLocationChange, that means the token exists and has the expected value. If you don't pass a token to _applyPrefToZoom it will invoke _getBrowserToken(aBrowser) synchronously, and I'd expect it to get the same exact value you are passing in, at that point since you just verified it is current.
What am I missing?

@@ +258,4 @@
>      // Media documents should always start at 1, and are not affected by prefs.
>      if (!aIsTabSwitch && browser.contentDocument.mozSyntheticDocument) {
>        ZoomManager.setZoomForBrowser(browser, 1);
> +      // Zoom token already incremented above.

above is a bit generic, better to say "by _ignorePendingZoomAccesses"

@@ +285,3 @@
>          }
> +        this._applyPrefToZoom(value, browser, {
> +          token: token,

ditto about my doubt, above you check !token.isCurrent, and bail out

@@ +459,5 @@
>      return {
> +      token: this._browserTokens[outerID],
> +      get isCurrent() {
> +        return !(outerID in self._browserTokens) ? false :
> +               self._browserTokens[outerID] === this.token;

If I read this correctly, you just set a missing token to 0, and .token is not a getter, so this.token is always a number >= 0. in the case you are handling here you would get undefined === number, that is already false, so the check doesn't appear useful.

@@ +475,5 @@
> +  _ignorePendingZoomAccesses: function FullZoom__ignorePendingZoomAccesses(browser) {
> +    let outerID = this._browserOuterID(browser);
> +    if (!(outerID in this._browserTokens))
> +      this._browserTokens[outerID] = 0;
> +    this._browserTokens[outerID]++;

nit: with a Map you could do: m.set(outerID, (m.get(outerID) + 1) || 0);
Created attachment 772706
tokens again 2

(In reply to Marco Bonardo [:mak] from comment #182)
> Or you may even use a WeakMap with the dom window as the key, then you might
> actually stop caring about removing entries from it, since they would expire
> naturally. Just be sure to not use XUL objects as the keys, only DOM objects
> are supported.

That sounded like a great idea, but unfortunately I don't think it's possible in this case.  The JS holds onto windows so it can look them up in the map later when isCurrent is called, preventing them from being collected when they're closed.

So I made it a Map (with outer window ID keys) and renamed it _browserTokenMap like you suggest.

> @@ +213,4 @@
> >        handleResult: function () hasPref = true,
> >        handleCompletion: function () {
> > +        if (token.isCurrent && !hasPref)
> > +          this._applyPrefToZoom(undefined, browser, { token: token });
> 
> I have a doubt, before any call to applyPrefToZoom you always check
> token.isCurrent, both here and in onLocationChange, that means the token
> exists and has the expected value. If you don't pass a token to
> _applyPrefToZoom it will invoke _getBrowserToken(aBrowser) synchronously,
> and I'd expect it to get the same exact value you are passing in, at that
> point since you just verified it is current.

You're right, thanks.

https://tbpl.mozilla.org/?tree=Try&rev=e9ffd7db97b9
https://hg.mozilla.org/integration/mozilla-inbound/rev/f8057a4c1e18
https://hg.mozilla.org/mozilla-central/rev/f8057a4c1e18

Epic.
https://hg.mozilla.org/releases/mozilla-beta/rev/44875df92eee


Intermittent browser_bug386835.js | Tab 3 should have zoomed as it was loading in the background - Got 1, expected 1.100000023841858 (and two more)

intermittent-failure

Bug 880226 - Disable browser_bug386835.js for too many intermittent failures, whilst we wait for review 

Bug 880226 - Fix intermittent browser_bug386835.js by improving browser-fullZoom.js's async handling. r=mak 