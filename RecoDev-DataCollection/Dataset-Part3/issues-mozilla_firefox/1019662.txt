Created attachment 8433380
mochi.social

12:57:19     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | all provider prefs uninstalled from previous test
12:57:19     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | all providers uninstalled from previous test 0
12:57:19     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | runSocialTests: finish test run with 0 providers
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:59 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: getFrameWorkerHandle/< :: line 59
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:161 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: ParentPort.prototype._dopost/< :: line 161
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:161 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: ParentPort.prototype._dopost/< :: line 161
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:161 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: ParentPort.prototype._dopost/< :: line 161
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:161 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: ParentPort.prototype._dopost/< :: line 161
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
1

Created attachment 8433380
mochi.social

12:57:19     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | all provider prefs uninstalled from previous test
12:57:19     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | all providers uninstalled from previous test 0
12:57:19     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | runSocialTests: finish test run with 0 providers
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:59 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: getFrameWorkerHandle/< :: line 59
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:161 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: ParentPort.prototype._dopost/< :: line 161
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:161 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: ParentPort.prototype._dopost/< :: line 161
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:161 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: ParentPort.prototype._dopost/< :: line 161
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
12:57:19  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | A promise chain failed to handle a rejection at resource://gre/modules/FrameWorker.jsm:161 - A promise chain failed to handle a rejection: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]
12:57:19     INFO -  Stack trace:
12:57:19     INFO -      JS frame :: resource://gre/modules/FrameWorker.jsm :: ParentPort.prototype._dopost/< :: line 161
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: Handler.prototype.process :: line 863
12:57:19     INFO -  JS frame :: resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js :: this.PromiseWalker.walkerLoop :: line 742
12:57:19     INFO -  native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
1
Comment on attachment 8433380
mochi.social

Review of attachment 8433380:
-----------------------------------------------------------------

Are you sure adding a null check fixes the error in comment 0?

"Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIMessageSender.sendAsyncMessage]" seems to indicate that we do have a non-null object implementing sendAsyncMessage.

::: toolkit/components/social/FrameWorker.jsm
@@ +62,5 @@
> +      // we reach this point.
> +      return;
> +    }
> +    manager.sendAsyncMessage("frameworker:connect",
> +      { portId: portid });

nit: this can now fit on a single 80 columns line.
Comment on attachment 8433380
mochi.social

Review of attachment 8433380:
-----------------------------------------------------------------

I think Florian is correct - the manager isn't null, but the other side is dead.  A trailing .then(null, Cu.reportError) type construct is probably OK.
Created attachment 8434042
Catch the error

Good point.
Comment on attachment 8434042
Catch the error

Review of attachment 8434042:
-----------------------------------------------------------------

There's probably still a real bug here that should be investigated someday, but I guess reporting the error to the console is a good step forward :-).
Try: https://tbpl.mozilla.org/?tree=Try&rev=39629fe6a3b1
(In reply to Florian Quèze [:florian] [:flo] from comment #4)
> There's probably still a real bug here that should be investigated someday,
> but I guess reporting the error to the console is a good step forward :-).

I think the tests are just tearing down a provider immediately after creating it.
(In reply to Mark Hammond [:markh] from comment #6)
> (In reply to Florian Quèze [:florian] [:flo] from comment #4)
> > There's probably still a real bug here that should be investigated someday,
> > but I guess reporting the error to the console is a good step forward :-).
> 
> I think the tests are just tearing down a provider immediately after
> creating it.

I remember seeing months ago similar nsIMessageSender.sendAsyncMessage failures (maybe not for the frameworker:connect message though) during shutdown on my local debug build.
https://hg.mozilla.org/integration/fx-team/rev/41817bdae9f0
https://hg.mozilla.org/mozilla-central/rev/41817bdae9f0
