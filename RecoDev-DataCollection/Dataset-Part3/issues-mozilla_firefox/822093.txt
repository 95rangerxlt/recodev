Happening pretty frequently.

https://tbpl.mozilla.org/php/getParsedLog.php?id=17990254&tree=Mozilla-Inbound

Rev3 Fedora 12 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-15 23:48:08 PST for push 3e4e600adc3b
slave: talos-r3-fed-036

TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Window 2 is private
TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Last window opened is the one selected
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
Stack trace:
    JS frame :: chrome://mochikit/content/browser-test.js :: test_is :: line 474
    JS frame :: chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js :: observe :: line 145
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_saveStateObject :: line 3685
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_saveState :: line 3672
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_onTimerCallback :: line 1138
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_observe :: line 579
    native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0

TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Selected window is updated to match one of the saved windows
TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Saved window is not private
TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Saved window is not private
TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Saved window is not private
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Stack trace:
    JS frame :: chrome://mochikit/content/browser-test.js :: test_is :: line 474
    JS frame :: chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js :: observe :: line 152
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_saveStateObject :: line 3685
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_saveState :: line 3672
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_onTimerCallback :: line 1138
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_observe :: line 579
    native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0

INFO TEST-END | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | finished in 6485ms

Happening pretty frequently.

https://tbpl.mozilla.org/php/getParsedLog.php?id=17990254&tree=Mozilla-Inbound

Rev3 Fedora 12 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-15 23:48:08 PST for push 3e4e600adc3b
slave: talos-r3-fed-036

TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Window 2 is private
TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Last window opened is the one selected
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
Stack trace:
    JS frame :: chrome://mochikit/content/browser-test.js :: test_is :: line 474
    JS frame :: chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js :: observe :: line 145
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_saveStateObject :: line 3685
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_saveState :: line 3672
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_onTimerCallback :: line 1138
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_observe :: line 579
    native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0

TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Selected window is updated to match one of the saved windows
TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Saved window is not private
TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Saved window is not private
TEST-PASS | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | Saved window is not private
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Stack trace:
    JS frame :: chrome://mochikit/content/browser-test.js :: test_is :: line 474
    JS frame :: chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js :: observe :: line 152
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_saveStateObject :: line 3685
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_saveState :: line 3672
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_onTimerCallback :: line 1138
    JS frame :: resource:///modules/sessionstore/SessionStore.jsm :: ssi_observe :: line 579
    native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0

INFO TEST-END | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | finished in 6485ms
https://tbpl.mozilla.org/php/getParsedLog.php?id=17989200&tree=Mozilla-Inbound
https://tbpl.mozilla.org/php/getParsedLog.php?id=17989224&tree=Mozilla-Inbound
https://tbpl.mozilla.org/php/getParsedLog.php?id=17986475&tree=Mozilla-Inbound
https://tbpl.mozilla.org/php/getParsedLog.php?id=17988151&tree=Mozilla-Inbound
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=17993826&tree=Mozilla-Inbound
Rev3 Fedora 12x64 mozilla-inbound debug test mochitest-browser-chrome on 2012-12-16 05:22:59
slave: talos-r3-fed64-044

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=17999308&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound pgo test mochitest-browser-chrome on 2012-12-16 12:00:16
slave: talos-r3-w7-031

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=18000912&tree=Mozilla-Inbound
Rev3 Fedora 12 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-16 15:03:32
slave: talos-r3-fed-054

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=18001971&tree=Mozilla-Inbound
Rev3 Fedora 12 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-16 16:59:51
slave: talos-r3-fed-066

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=18003005&tree=Mozilla-Inbound
Rev3 Fedora 12 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-16 17:49:41
slave: talos-r3-fed-022

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=18005582&tree=Mozilla-Inbound
Rev3 Fedora 12 mozilla-inbound debug test mochitest-browser-chrome on 2012-12-16 19:24:23
slave: talos-r3-fed-063

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=18003577&tree=Mozilla-Inbound
Rev3 Fedora 12x64 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-16 18:19:24
slave: talos-r3-fed64-041

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Bug 819510 backed out on inbound, so these should stop once it propagates.
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=18012734&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-17 04:16:21
slave: talos-r3-w7-083

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=18013307&tree=Mozilla-Inbound
Rev3 Fedora 12x64 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-17 04:42:24
slave: talos-r3-fed64-003

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
vporof
https://tbpl.mozilla.org/php/getParsedLog.php?id=18014750&tree=Try
Rev3 Fedora 12 try opt test mochitest-browser-chrome on 2012-12-17 05:37:59
slave: talos-r3-fed-020

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
https://tbpl.mozilla.org/php/getParsedLog.php?id=17992302&tree=Mozilla-Inbound
Created attachment 692976
Patch v1

The problem is that we should wait for a window to close, in order to continue the test, saving state, etc. I added a executeSoon.  

The test is running fine locally. 
Pushed to try for a test run: https://tbpl.mozilla.org/?tree=Try&rev=79f383e56596
Comment on attachment 692976
Patch v1

Review of attachment 692976:
-----------------------------------------------------------------

If we need to wait for the window to close then maybe we should do exactly that. Waiting an arbitrary amount of time is not the solution here as the test would still be failing intermittently.
Created attachment 692982
Patch v2

Added observer to get the window close event. 

https://tbpl.mozilla.org/?tree=Try&rev=17c1e98fec0f
jimm
https://tbpl.mozilla.org/php/getParsedLog.php?id=18022593&tree=Elm
Rev3 Fedora 12x64 elm opt test mochitest-browser-chrome on 2012-12-17 10:11:39
slave: talos-r3-fed64-063

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
seth
https://tbpl.mozilla.org/php/getParsedLog.php?id=18026303&tree=Try
Rev3 Fedora 12x64 try opt test mochitest-browser-chrome on 2012-12-17 12:49:49
slave: talos-r3-fed64-056

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
edmorley
https://tbpl.mozilla.org/php/getParsedLog.php?id=18024402&tree=Profiling
Rev3 Fedora 12 profiling opt test mochitest-browser-chrome on 2012-12-17 11:30:57
slave: talos-r3-fed-003

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
jimm
https://tbpl.mozilla.org/php/getParsedLog.php?id=18023895&tree=Elm
Rev3 WINNT 6.1 elm opt test mochitest-browser-chrome on 2012-12-17 11:01:11
slave: talos-r3-w7-083

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
All green on try :)

https://tbpl.mozilla.org/?tree=Try&rev=17c1e98fec0f
Comment on attachment 692982
Patch v2

Review of attachment 692982:
-----------------------------------------------------------------

Thank you, looks good.

r=me with the fixes below.

::: browser/components/sessionstore/test/browser_819510_perwindowpb.js
@@ +34,1 @@
>        currentWindow.close();

We can use closeAllButPrimaryWindow() here.

@@ +144,5 @@
>    });
>  }
>  
> +function waitForWindowClose(aWin, aCallback) {
> +  Services.obs.addObserver(function observe(aSubject, aTopic, aData) {

Need to compare aWin and aSubject here before continuing.

@@ +161,5 @@
> +      aSubject.QueryInterface(Ci.nsISupportsString);
> +      aCallback(JSON.parse(aSubject.data));
> +    }
> +  }, "sessionstore-state-write", false);
> +  Services.prefs.setIntPref("browser.sessionstore.interval", 0);

Let's decrease the interval once at the beginning and then use waitForSaveState().
Created attachment 693393
Patch v3

(In reply to Tim Taubert [:ttaubert] from comment #22)
> Comment on attachment 692982
> Patch v2
> 
> Review of attachment 692982:
> -----------------------------------------------------------------
> 
> Thank you, looks good.
> 
> r=me with the fixes below.
> 
> ::: browser/components/sessionstore/test/browser_819510_perwindowpb.js
> @@ +34,1 @@
> >        currentWindow.close();
> 
> We can use closeAllButPrimaryWindow() here.
> 

Done. 

> @@ +144,5 @@
> >    });
> >  }
> >  
> > +function waitForWindowClose(aWin, aCallback) {
> > +  Services.obs.addObserver(function observe(aSubject, aTopic, aData) {
> 
> Need to compare aWin and aSubject here before continuing.

The subject for |xul-window-destroyed| is null. So, we can't compare it to the window. 

> @@ +161,5 @@
> > +      aSubject.QueryInterface(Ci.nsISupportsString);
> > +      aCallback(JSON.parse(aSubject.data));
> > +    }
> > +  }, "sessionstore-state-write", false);
> > +  Services.prefs.setIntPref("browser.sessionstore.interval", 0);
> 
> Let's decrease the interval once at the beginning and then use
> waitForSaveState().

|waitForSaveState| doesn't return the state for comparison (aSubject.data), also we need to force at a certain point to write the state, independently from opening/closing windows. I updated the method name for clarity.
(In reply to Andres Hernandez [:andreshm] from comment #23)
> > > +function waitForWindowClose(aWin, aCallback) {
> > > +  Services.obs.addObserver(function observe(aSubject, aTopic, aData) {
> > 
> > Need to compare aWin and aSubject here before continuing.
> 
> The subject for |xul-window-destroyed| is null. So, we can't compare it to
> the window. 

Right, let's just use domwindowclosed then.

> > @@ +161,5 @@
> > > +      aSubject.QueryInterface(Ci.nsISupportsString);
> > > +      aCallback(JSON.parse(aSubject.data));
> > > +    }
> > > +  }, "sessionstore-state-write", false);
> > > +  Services.prefs.setIntPref("browser.sessionstore.interval", 0);
> > 
> > Let's decrease the interval once at the beginning and then use
> > waitForSaveState().
> 
> |waitForSaveState| doesn't return the state for comparison (aSubject.data),
> also we need to force at a certain point to write the state, independently
> from opening/closing windows. I updated the method name for clarity.

Ok, I don't mind keeping the existing code.
Created attachment 693403
Patch v4

Updated patch
seth
https://tbpl.mozilla.org/php/getParsedLog.php?id=18082297&tree=Try
Rev3 Fedora 12x64 try debug test mochitest-browser-chrome on 2012-12-18 20:46:08
slave: talos-r3-fed64-005

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Failed on try :(
I think this was the run on bug 819510 comment 25, that was using the executeSoon patch. Just to be sure, I added a new run on try with the rebased full patch on bug 819510 comment 26. See: https://tbpl.mozilla.org/?tree=Try&rev=7030fd2cd0e3
Yes I did refer to bug 819510 comment 25, and looks like that didn't use executeSoon():

https://hg.mozilla.org/try/rev/17c1e98fec0f
Well, the latest push failed too. :(

https://tbpl.mozilla.org/?tree=Try&rev=7030fd2cd0e3

I'll take a look again on this.
For future reference you can just run the mochitest-bc tests on try to conserve resources.
Sure, thanks for letting me know!
tnikkel
https://tbpl.mozilla.org/php/getParsedLog.php?id=18286145&tree=Mozilla-Inbound
Rev3 Fedora 12x64 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-26 21:09:04
slave: talos-r3-fed64-020

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=18287101&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-26 22:08:32
slave: talos-r3-w7-047

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
jacek
https://tbpl.mozilla.org/php/getParsedLog.php?id=18292898&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-27 05:31:53
slave: talos-r3-w7-068

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
This bug was fixed with latest patch on Bug 819510 comment 31
mbrubeck
https://tbpl.mozilla.org/php/getParsedLog.php?id=18302782&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-27 14:14:40
slave: talos-r3-w7-045

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
WG9s
https://tbpl.mozilla.org/php/getParsedLog.php?id=18303994&tree=Firefox
Rev3 WINNT 6.1 mozilla-central opt test mochitest-browser-chrome on 2012-12-27 14:59:24
slave: talos-r3-w7-069

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
mbrubeck
https://tbpl.mozilla.org/php/getParsedLog.php?id=18304909&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-27 15:46:41
slave: talos-r3-w7-026

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
jdm
https://tbpl.mozilla.org/php/getParsedLog.php?id=18311277&tree=Mozilla-Inbound
Rev3 Fedora 12 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-27 22:49:13
slave: talos-r3-fed-015

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Andes, the orange in comment 40 definitely occurred after the landing of bug 819510.
jmaher%mozilla.com
https://tbpl.mozilla.org/php/getParsedLog.php?id=18314647&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 02:17:29
slave: talos-r3-w7-085

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
jdm
https://tbpl.mozilla.org/php/getParsedLog.php?id=18321446&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 09:57:22
slave: talos-r3-w7-051

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
jdm
https://tbpl.mozilla.org/php/getParsedLog.php?id=18321711&tree=Mozilla-Inbound
Rev3 Fedora 12x64 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 10:14:30
slave: talos-r3-fed64-026

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
(In reply to Josh Matthews [:jdm] from comment #41)
> Andes, the orange in comment 40 definitely occurred after the landing of bug
> 819510.

I'll take a look again at this :(, I don't have a clue why the window is not being registered as closed, since I added a check to continue only when |aWin.closed| is true. If you have any idea please let me know.
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=18322853&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 10:49:48
slave: talos-r3-w7-064

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Created attachment 696410
Patch v5

I updated the test to use the 'SSWindowClosing' event to get notified when the window is closing in the session store module. But, also, I'm double checking the browser state to continue only when the window is moved to |_closedWindows|. Since, this happens a moment after 'SSWindowClosing' event.
Pushed to try: https://tbpl.mozilla.org/?tree=Try&rev=c50cffce634b
jdm
https://tbpl.mozilla.org/php/getParsedLog.php?id=18326336&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 13:56:51
slave: talos-r3-w7-077

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=18315882&tree=Profiling
Rev3 WINNT 6.1 profiling pgo test mochitest-browser-chrome on 2012-12-28 03:58:05
slave: talos-r3-w7-025

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=18328524&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 16:07:28
slave: talos-r3-xp-091

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=18329349&tree=Mozilla-Inbound
Rev3 Fedora 12 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 16:44:36
slave: talos-r3-fed-007

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
mbrubeck
https://tbpl.mozilla.org/php/getParsedLog.php?id=18332291&tree=Mozilla-Inbound
Rev3 Fedora 12x64 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 20:15:13
slave: talos-r3-fed64-054

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
mbrubeck
https://tbpl.mozilla.org/php/getParsedLog.php?id=18329463&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 16:48:13
slave: talos-r3-w7-101

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
mbrubeck
https://tbpl.mozilla.org/php/getParsedLog.php?id=18332621&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-28 20:41:53
slave: talos-r3-w7-047

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
All green on try: https://tbpl.mozilla.org/?tree=Try&rev=c50cffce634b
WG9s
https://tbpl.mozilla.org/php/getParsedLog.php?id=18336352&tree=Firefox
Rev3 WINNT 6.1 mozilla-central opt test mochitest-browser-chrome on 2012-12-29 05:15:23
slave: talos-r3-w7-054

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
graememcc_firefox%graeme-online.co.uk
https://tbpl.mozilla.org/php/getParsedLog.php?id=18337519&tree=Firefox
Rev3 WINNT 6.1 mozilla-central pgo test mochitest-browser-chrome on 2012-12-29 06:46:52
slave: talos-r3-w7-024

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
ehsan
https://tbpl.mozilla.org/php/getParsedLog.php?id=18346879&tree=Mozilla-Inbound
Rev3 Fedora 12 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-29 18:21:24
slave: talos-r3-fed-042

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
ehsan
https://tbpl.mozilla.org/php/getParsedLog.php?id=18348991&tree=Firefox
Rev3 Fedora 12 mozilla-central opt test mochitest-browser-chrome on 2012-12-29 22:16:25
slave: talos-r3-fed-045

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
ehsan
https://tbpl.mozilla.org/php/getParsedLog.php?id=18348461&tree=Firefox
Rev3 WINNT 5.1 mozilla-central opt test mochitest-browser-chrome on 2012-12-29 21:52:25
slave: talos-r3-xp-080

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/devtools/profiler/test/browser_profiler_run.js | First percentage is 100% - Got , expected 100.0%
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=18348423&tree=Mozilla-Inbound
Rev3 Fedora 12x64 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-29 21:50:27
slave: talos-r3-fed64-046

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
:emk
https://tbpl.mozilla.org/php/getParsedLog.php?id=18356398&tree=Try
Rev3 WINNT 6.1 try opt test mochitest-browser-chrome on 2012-12-30 12:07:23
slave: talos-r3-w7-080

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=18359585&tree=Firefox
Rev3 WINNT 6.1 mozilla-central opt test mochitest-browser-chrome on 2012-12-30 17:24:26
slave: talos-r3-w7-085

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=18360620&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-30 18:53:31
slave: talos-r3-w7-039

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Ms2ger%gmail.com
https://tbpl.mozilla.org/php/getParsedLog.php?id=18357474&tree=Try
Rev3 Fedora 12x64 try opt test mochitest-browser-chrome on 2012-12-30 14:33:14
slave: talos-r3-fed64-030

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Ms2ger%gmail.com
https://tbpl.mozilla.org/php/getParsedLog.php?id=18357759&tree=Try
Rev3 WINNT 6.1 try opt test mochitest-browser-chrome on 2012-12-30 14:58:41
slave: talos-r3-w7-079

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
graememcc_firefox%graeme-online.co.uk
https://tbpl.mozilla.org/php/getParsedLog.php?id=18363267&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2012-12-31 01:16:55
slave: talos-r3-w7-005

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
Comment on attachment 696410
Patch v5

Review of attachment 696410:
-----------------------------------------------------------------

This seems reasonable to me.
https://hg.mozilla.org/integration/mozilla-inbound/rev/48d40bb9a11e
jimm
https://tbpl.mozilla.org/php/getParsedLog.php?id=18376669&tree=Elm
Rev3 WINNT 6.1 elm opt test mochitest-browser-chrome on 2012-12-31 13:09:18
slave: talos-r3-w7-090

TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 2 windows in data being writted to disk - Got 3, expected 2
TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/sessionstore/test/browser_819510_perwindowpb.js | sessionstore state: 1 closed window in data being writted to disk - Got 0, expected 1
https://hg.mozilla.org/mozilla-central/rev/48d40bb9a11e
Let's leave this open until we're sure it's fixed.
If you want the bug left open, please put [leave open] on the whiteboard when you push to inbound.
Seems like this is working fine! :)
