https://tbpl.mozilla.org/php/getParsedLog.php?id=21286014&tree=Mozilla-Inbound

Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-03-30 14:39:21 PDT for push 0e7b1dd41868
slave: talos-r4-lion-028

14:47:07     INFO -  TEST-START | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js
14:47:07     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Console message: OpenGL LayerManager Initialized Succesfully.
14:47:07     INFO -  Version: 2.1 NVIDIA-7.12.9
14:47:07     INFO -  Vendor: NVIDIA Corporation
14:47:07     INFO -  Renderer: NVIDIA GeForce 320M OpenGL Engine
14:47:07     INFO -  FBO Texture Target: TEXTURE_2D
14:47:07     INFO -  1364680027944	Sync.Status	DEBUG	Status.login: error.login.reason.no_username => error.login.reason.no_username
14:47:07     INFO -  1364680027944	Sync.Status	DEBUG	Status.service: service.client_not_configured => service.client_not_configured
14:47:08  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
14:47:08     INFO -  Stack trace:
14:47:08     INFO -      JS frame :: chrome://mochikit/content/browser-test.js :: test_isnot :: line 506
14:47:08     INFO -      JS frame :: chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js :: doTest/onLoad/< :: line 20
14:47:08     INFO -      JS frame :: chrome://browser/content/browser.js :: FullZoom__applySettingToPref/<.handleCompletion< :: line 1714
14:47:08     INFO -      JS frame :: resource://gre/modules/ContentPrefService2.jsm :: safeCallback :: line 769
14:47:08     INFO -      JS frame :: resource://gre/modules/ContentPrefService2.jsm :: cbHandleCompletion :: line 758
14:47:08     INFO -      JS frame :: resource://gre/modules/ContentPrefService2.jsm :: onDone :: line 263
14:47:08     INFO -      JS frame :: resource://gre/modules/ContentPrefService2.jsm :: handleCompletion :: line 635
14:47:08     INFO -      native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
14:47:08     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Console message: OpenGL LayerManager Initialized Succesfully.
14:47:08     INFO -  Version: 2.1 NVIDIA-7.12.9
14:47:08     INFO -  Vendor: NVIDIA Corporation
14:47:08     INFO -  Renderer: NVIDIA GeForce 320M OpenGL Engine
14:47:08     INFO -  FBO Texture Target: TEXTURE_2D
14:47:08     INFO -  1364680028506	Sync.Status	DEBUG	Status.login: error.login.reason.no_username => error.login.reason.no_username
14:47:08     INFO -  1364680028506	Sync.Status	DEBUG	Status.service: service.client_not_configured => service.client_not_configured
14:47:08     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:privatebrowsing should be reset
14:47:09     INFO -  INFO TEST-END | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | finished in 1417ms

https://tbpl.mozilla.org/php/getParsedLog.php?id=21286014&tree=Mozilla-Inbound

Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-03-30 14:39:21 PDT for push 0e7b1dd41868
slave: talos-r4-lion-028

14:47:07     INFO -  TEST-START | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js
14:47:07     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Console message: OpenGL LayerManager Initialized Succesfully.
14:47:07     INFO -  Version: 2.1 NVIDIA-7.12.9
14:47:07     INFO -  Vendor: NVIDIA Corporation
14:47:07     INFO -  Renderer: NVIDIA GeForce 320M OpenGL Engine
14:47:07     INFO -  FBO Texture Target: TEXTURE_2D
14:47:07     INFO -  1364680027944	Sync.Status	DEBUG	Status.login: error.login.reason.no_username => error.login.reason.no_username
14:47:07     INFO -  1364680027944	Sync.Status	DEBUG	Status.service: service.client_not_configured => service.client_not_configured
14:47:08  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
14:47:08     INFO -  Stack trace:
14:47:08     INFO -      JS frame :: chrome://mochikit/content/browser-test.js :: test_isnot :: line 506
14:47:08     INFO -      JS frame :: chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js :: doTest/onLoad/< :: line 20
14:47:08     INFO -      JS frame :: chrome://browser/content/browser.js :: FullZoom__applySettingToPref/<.handleCompletion< :: line 1714
14:47:08     INFO -      JS frame :: resource://gre/modules/ContentPrefService2.jsm :: safeCallback :: line 769
14:47:08     INFO -      JS frame :: resource://gre/modules/ContentPrefService2.jsm :: cbHandleCompletion :: line 758
14:47:08     INFO -      JS frame :: resource://gre/modules/ContentPrefService2.jsm :: onDone :: line 263
14:47:08     INFO -      JS frame :: resource://gre/modules/ContentPrefService2.jsm :: handleCompletion :: line 635
14:47:08     INFO -      native frame :: <unknown filename> :: <TOP_LEVEL> :: line 0
14:47:08     INFO -  TEST-INFO | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Console message: OpenGL LayerManager Initialized Succesfully.
14:47:08     INFO -  Version: 2.1 NVIDIA-7.12.9
14:47:08     INFO -  Vendor: NVIDIA Corporation
14:47:08     INFO -  Renderer: NVIDIA GeForce 320M OpenGL Engine
14:47:08     INFO -  FBO Texture Target: TEXTURE_2D
14:47:08     INFO -  1364680028506	Sync.Status	DEBUG	Status.login: error.login.reason.no_username => error.login.reason.no_username
14:47:08     INFO -  1364680028506	Sync.Status	DEBUG	Status.service: service.client_not_configured => service.client_not_configured
14:47:08     INFO -  TEST-PASS | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:privatebrowsing should be reset
14:47:09     INFO -  INFO TEST-END | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | finished in 1417ms
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21286713&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-03-30 15:13:06
slave: talos-r3-w7-057

15:22:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
Going out on a limb that bug 829456 regressed this.
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21287756&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound pgo test mochitest-browser-chrome on 2013-03-30 16:18:10
slave: talos-r3-xp-098

16:21:37  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug719271.js | Test timed out
16:21:39  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug719271.js | Found a tab after previous test timed out: http://example.org/browser/browser/base/content/test/video.ogg
16:21:39  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug719271.js | Found a tab after previous test timed out: http://example.org/browser/browser/base/content/test/video.ogg
16:25:29  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21287844&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound pgo test mochitest-browser-chrome on 2013-03-30 16:23:26
slave: talos-r3-xp-050

16:31:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21287841&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound pgo test mochitest-browser-chrome on 2013-03-30 16:23:36
slave: talos-r3-xp-071

16:30:49  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=21290934&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-03-30 21:49:29
slave: talos-r3-w7-038

21:59:03  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
Pushed a bunch of logging to try.  Guess I'll keep rerunning tests until there's a failure.  https://tbpl.mozilla.org/?tree=Try&rev=c5ce93974cf2

Worst case, the test could be rewritten slightly not to assume the zoom level of the freshly loaded about:blank is 1.  That would probably fix the random failure, but it wouldn't fix whatever's causing it not to be 1.  It should be 1.

Looking at this, I noticed there's a problem with content pref observers.  Observers are notified when prefs change, but they aren't told if changes took place in the temporary private-browsing store or the normal permanent store.  FullZoom could hypothetically get tripped up by that (e.g., by applying a zoom level that changed in a PB window to a page outside of PB), but I don't think that's the problem here.
tbsaunde
https://tbpl.mozilla.org/php/getParsedLog.php?id=21300837&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound pgo test mochitest-browser-chrome on 2013-03-31 15:37:08
slave: talos-r3-xp-056

15:44:42  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
jesup
https://tbpl.mozilla.org/php/getParsedLog.php?id=21304083&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-03-31 20:18:07
slave: talos-r3-xp-010

20:25:50  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=21296712&tree=Mozilla-Inbound
Rev4 MacOSX Snow Leopard 10.6 mozilla-inbound opt test mochitest-browser-chrome on 2013-03-31 07:16:36
slave: talos-r4-snow-010

07:23:32  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
Ms2ger%gmail.com
https://tbpl.mozilla.org/php/getParsedLog.php?id=21305104&tree=Mozilla-Inbound
Rev3 WINNT 6.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-03-31 23:49:09
slave: talos-r3-w7-053

23:57:34  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
00:14:58  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/toolkit/content/tests/browser/browser_default_image_filename.js | Test timed out
00:15:28  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/toolkit/content/tests/browser/browser_save_resend_postdata.js | Test timed out
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21309699&tree=Firefox
Rev4 MacOSX Lion 10.7 mozilla-central opt test mochitest-browser-chrome on 2013-04-01 04:46:17
slave: talos-r4-lion-049

04:52:17  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/social/browser_social_window.js | Social:ToggleNotifications visible? - Got true, expected false
04:54:10  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21313929&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 09:07:41
slave: talos-r4-lion-010

09:15:06  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21314807&tree=Mozilla-Inbound
Rev4 MacOSX Snow Leopard 10.6 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 09:48:06
slave: talos-r4-snow-077

09:56:07  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21314765&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 09:43:04
slave: talos-r4-lion-050

09:52:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21316095&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 10:43:11
slave: talos-r3-xp-033

10:51:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_DownloadLastDirWithCPS.js | uri1 should return the expected last directory - Got C:\DOCUME~1\cltbld\LOCALS~1\Temp\testdir, expected C:\DOCUME~1\cltbld\LOCALS~1\Temp
10:51:21  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_DownloadLastDirWithCPS.js | uri1 should return null - Got [xpconnect wrapped nsIFile], expected null
10:51:22  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_DownloadLastDirWithCPS.js | uri1 should return null - Got [xpconnect wrapped nsIFile], expected null
10:51:23  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_DownloadLastDirWithCPS.js | uri1 should return null - Got [xpconnect wrapped nsIFile], expected null
10:51:23  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_DownloadLastDirWithCPS.js | uri1 should return null - Got [xpconnect wrapped nsIFile], expected null
10:51:27  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_downloadLastDir.js | File picker should start with browser.download.lastDir - Got C:\DOCUME~1\cltbld\LOCALS~1\Temp\testdir, expected C:\DOCUME~1\cltbld\LOCALS~1\Temp
10:51:52  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21317213&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 11:19:28
slave: talos-r3-xp-049

11:27:55  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21318862&tree=Firefox
Rev4 MacOSX Lion 10.7 mozilla-central opt test mochitest-browser-chrome on 2013-04-01 12:10:02
slave: talos-r4-lion-055

12:18:58  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21319628&tree=Mozilla-Inbound
Rev4 MacOSX Lion 10.7 mozilla-inbound debug test mochitest-browser-chrome on 2013-04-01 11:34:19
slave: talos-r4-lion-073

11:52:43  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
bz
https://tbpl.mozilla.org/php/getParsedLog.php?id=21322025&tree=Try
Rev3 WINNT 6.1 try opt test mochitest-browser-chrome on 2013-04-01 13:31:36
slave: talos-r3-w7-082

13:42:02  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=21325571&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 15:10:05
slave: talos-r3-xp-001

15:18:41  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
It's just not failing on try.

So I landed this change on inbound instead.  It does what comment 7 says -- it makes the test not assume the initial zoom is 1.  That should fix the failure, but the underlying problem is still there, so I also added some logging to the test.  I doubt it's enough to be helpful though.  I'll probably have to add debug-build logging to browser-fullZoom.js...

https://hg.mozilla.org/integration/mozilla-inbound/rev/98b7ab4fa80f
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=21334379&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 20:02:43
slave: talos-r3-xp-007

20:07:16  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug719271.js | Test timed out
20:07:18  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug719271.js | Found a tab after previous test timed out: http://example.org/browser/browser/base/content/test/video.ogg
20:07:18  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/base/content/test/browser_bug719271.js | Found a tab after previous test timed out: http://example.org/browser/browser/base/content/test/video.ogg
20:11:20  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
That didn't work, but the logging helped.  0 for 2.

The initial zoom is 1, but after FullZoom.enlarge, the zoom is still 1.  Is the enlarge just not working?  Is there some other async thing happening that sets the zoom after the enlarge finishes changing it but before it can call the callback?
philor
https://tbpl.mozilla.org/php/getParsedLog.php?id=21337377&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 22:02:00
slave: talos-r3-xp-007

22:10:15  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
OK, I think I may know what's happening.  FullZoom.onLocationChange is called as the result of the about:blank location change (by browser.js).  onLocationChange calls _applyPrefToSetting, which calls _getGlobalValue.  Because the test opened a new browser chrome window, FullZoom has not had a chance to cache the global zoom level value, so _getGlobalValue has to call cps2.getGlobal, which is async.  When that's done, the page's zoom is then set to 1, since there is no global value.

But the test doesn't wait for any of that to happen.  It only waits for page load.  So there are some runs where the zoom is set to 1 as described above between the time the test calls FullZoom.enlarge (also async) and the time it checks the zoom that's supposed to be enlarged.

I had to update a bunch of other tests to wait for onLocationChange's zoom set, so it's not surprising this test is failing this way, if I'm right.

https://hg.mozilla.org/integration/mozilla-inbound/rev/198a12d4affe
adw
https://tbpl.mozilla.org/php/getParsedLog.php?id=21338173&tree=Mozilla-Inbound
Rev3 WINNT 5.1 mozilla-inbound opt test mochitest-browser-chrome on 2013-04-01 22:42:15
slave: talos-r3-xp-034

22:50:32  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
https://hg.mozilla.org/mozilla-central/rev/98b7ab4fa80f
https://hg.mozilla.org/mozilla-central/rev/198a12d4affe

No occurrences since this landing!
RyanVM
https://tbpl.mozilla.org/php/getParsedLog.php?id=21467043&tree=Mozilla-Aurora
Rev3 WINNT 5.1 mozilla-aurora pgo test mochitest-browser-chrome on 2013-04-04 21:28:06
slave: talos-r3-xp-053

04:35:28  WARNING -  TEST-UNEXPECTED-FAIL | chrome://mochitests/content/browser/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_zoomrestore.js | Zoom level for about:blank should be changed - Didn't expect 1, but got it
https://hg.mozilla.org/releases/mozilla-aurora/rev/40f3bc7a4f36
https://hg.mozilla.org/releases/mozilla-aurora/rev/35b622d25550
